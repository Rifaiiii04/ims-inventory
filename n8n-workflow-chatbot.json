{
    "name": "WhatsApp Chatbot - UMKM Assistant",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "whatsapp-chatbot",
                "responseMode": "responseNode",
                "options": {}
            },
            "id": "webhook-whatsapp",
            "name": "Webhook - Terima Pesan WA",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1.1,
            "position": [240, 300],
            "webhookId": "whatsapp-chatbot-webhook"
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ { \"success\": true, \"message\": \"Pesan diterima\" } }}"
            },
            "id": "respond-webhook",
            "name": "Respond to Webhook",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [240, 500]
        },
        {
            "parameters": {
                "jsCode": "// Extract data dari webhook WAHA\n// Handle berbagai format dari WAHA\nconst rawBody = $input.item.json.body || $input.item.json;\nconst body = rawBody.payload || rawBody.data || rawBody;\n\n// Extract message text dari berbagai kemungkinan struktur\nlet message = '';\nif (body.message?.text) {\n  message = body.message.text;\n} else if (body.message?.body) {\n  message = body.message.body;\n} else if (body.text) {\n  message = body.text;\n} else if (body.message) {\n  message = typeof body.message === 'string' ? body.message : '';\n}\n\n// Extract from/chatId dari berbagai kemungkinan struktur\nlet from = '';\nif (body.from) {\n  from = body.from;\n} else if (body.chatId) {\n  from = body.chatId;\n} else if (body.message?.from) {\n  from = body.message.from;\n} else if (body.key?.remoteJid) {\n  from = body.key.remoteJid;\n} else if (body.payload?.from) {\n  from = body.payload.from;\n}\n\n// Extract messageId\nconst messageId = body.messageId || body.id || body.key?.id || body.message?.id || '';\nconst timestamp = body.timestamp || body.message?.timestamp || Date.now();\n\n// Normalize chatId format (WAHA format: 6281380630988@c.us)\nlet chatId = from;\nif (chatId) {\n  // Remove + jika ada\n  chatId = chatId.replace(/^\\+/, '');\n  // Tambahkan @c.us jika belum ada\n  if (!chatId.includes('@')) {\n    chatId = chatId + '@c.us';\n  }\n}\n\n// Debug: log raw data untuk troubleshooting\nconsole.log('Raw WAHA data:', JSON.stringify(rawBody, null, 2));\nconsole.log('Extracted message:', message);\nconsole.log('Extracted chatId:', chatId);\n\nreturn {\n  json: {\n    message: message.trim(),\n    chatId: chatId,\n    messageId: messageId,\n    timestamp: timestamp,\n    rawData: rawBody\n  }\n};"
            },
            "id": "extract-message",
            "name": "Extract Pesan",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [460, 300]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": false,
                        "leftValue": "",
                        "typeValidation": "loose"
                    },
                    "conditions": [
                        {
                            "id": "check-empty",
                            "leftValue": "={{ $json.message }}",
                            "rightValue": "",
                            "operator": {
                                "type": "string",
                                "operation": "notEmpty"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "check-message",
            "name": "Cek Pesan Kosong?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [680, 300]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyBzb2hZXhceAjTlW1nfiXdlK710-t5TQ20",
                "authentication": "none",
                "sendBody": true,
                "contentType": "json",
                "specifyBody": "json",
                "jsonBody": "={\n  \"contents\": [\n    {\n      \"parts\": [\n        {\n          \"text\": \"Anda adalah AI classifier untuk chatbot UMKM. Tugas Anda adalah mengklasifikasi pesan dari user ke dalam salah satu intent berikut:\\n\\n1. tambahStok - User ingin menambah stok bahan/produk (contoh: 'tambah stok beras 10', 'stok +5 untuk gula')\\n2. lihatStok - User ingin melihat daftar stok (contoh: 'lihat stok', 'cek inventory', 'stok apa saja')\\n3. laporanPenjualan - User ingin melihat laporan penjualan (contoh: 'laporan penjualan', 'sales report', 'penjualan hari ini')\\n4. laporanInventory - User ingin melihat laporan inventory (contoh: 'laporan inventory', 'laporan stok')\\n5. tambahProduk - User ingin menambah produk baru (contoh: 'tambah produk nasi goreng harga 15000', 'produk baru')\\n6. tambahKategori - User ingin menambah kategori baru (contoh: 'tambah kategori makanan', 'kategori baru minuman')\\n7. tambahVarian - User ingin menambah varian produk (contoh: 'tambah varian pedas untuk nasi goreng')\\n8. tambahKomposisi - User ingin menambah komposisi produk (contoh: 'tambah komposisi produk nasi goreng bahan beras jumlah 200')\\n9. help - User meminta bantuan atau menu (contoh: 'help', 'bantuan', 'menu', 'apa saja perintahnya')\\n10. chat - User ingin chat/konsultasi tentang bisnis, penjualan, atau pertanyaan umum lainnya\\n\\nPesan dari user: {{ $json.message }}\\n\\nJawablah HANYA dengan nama intent (salah satu dari: tambahStok, lihatStok, laporanPenjualan, laporanInventory, tambahProduk, tambahKategori, tambahVarian, tambahKomposisi, help, atau chat). Jangan tambahkan penjelasan apapun, hanya nama intent saja.\"\n        }\n      ]\n    }\n  ]\n}",
                "options": {}
            },
            "id": "ai-classify-intent",
            "name": "AI Agent - Classify Intent",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [900, 300],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Extract intent dari response Gemini AI\nconst geminiResponse = $input.item.json;\nconst originalMessage = $('Extract Pesan').item.json.message;\n\nlet intent = 'chat'; // default\nlet confidence = 0.5;\n\n// Extract intent dari response Gemini\nif (geminiResponse.candidates && geminiResponse.candidates[0]) {\n  const candidate = geminiResponse.candidates[0];\n  if (candidate.content && candidate.content.parts && candidate.content.parts[0]) {\n    const aiResponse = (candidate.content.parts[0].text || '').trim().toLowerCase();\n    \n    // Valid intent list\n    const validIntents = [\n      'tambahstok', 'lihatstok', 'laporanpenjualan', 'laporaninventory',\n      'tambahproduk', 'tambahkategori', 'tambahvarian', 'tambahkomposisi',\n      'help', 'chat'\n    ];\n    \n    // Cari intent yang cocok\n    for (const validIntent of validIntents) {\n      if (aiResponse.includes(validIntent)) {\n        intent = validIntent;\n        confidence = 0.95;\n        break;\n      }\n    }\n  }\n}\n\n// Fallback: jika AI gagal, gunakan pattern matching sederhana\nif (intent === 'chat' && confidence === 0.5) {\n  const message = originalMessage.toLowerCase().trim();\n  const patterns = {\n    tambahStok: /tambah\\s+stok|stok\\s+tambah|update\\s+stok|stok\\s+\\+|\\+\\s+stok/i,\n    lihatStok: /lihat\\s+stok|cek\\s+stok|stok\\s+apa|stok\\s+berapa|inventory/i,\n    laporanPenjualan: /laporan\\s+penjualan|laporan\\s+sales|penjualan|sales\\s+report|report\\s+penjualan/i,\n    laporanInventory: /laporan\\s+inventory|laporan\\s+stok|inventory\\s+report|report\\s+inventory/i,\n    tambahProduk: /tambah\\s+produk|produk\\s+baru|add\\s+product|create\\s+product/i,\n    tambahKategori: /tambah\\s+kategori|kategori\\s+baru|add\\s+category|create\\s+category/i,\n    tambahVarian: /tambah\\s+varian|varian\\s+baru|add\\s+variant|create\\s+variant/i,\n    tambahKomposisi: /tambah\\s+komposisi|komposisi\\s+baru|add\\s+composition|create\\s+composition/i,\n    help: /help|bantuan|menu|perintah|command|apa\\s+saja/i\n  };\n  \n  for (const [key, pattern] of Object.entries(patterns)) {\n    if (pattern.test(message)) {\n      intent = key;\n      confidence = 0.8;\n      break;\n    }\n  }\n}\n\nreturn {\n  json: {\n    ...$('Extract Pesan').item.json,\n    intent: intent,\n    confidence: confidence,\n    originalMessage: originalMessage,\n    aiClassification: geminiResponse.candidates?.[0]?.content?.parts?.[0]?.text || 'N/A'\n  }\n};"
            },
            "id": "detect-intent",
            "name": "Deteksi Intent",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [1120, 300]
        },
        {
            "parameters": {
                "mode": "assign",
                "duplicateItem": false,
                "assignments": {
                    "assignments": [
                        {
                            "id": "route-tambah-stok",
                            "name": "tambahStok",
                            "value": "={{ $json.intent === 'tambahStok' }}",
                            "type": "boolean"
                        },
                        {
                            "id": "route-lihat-stok",
                            "name": "lihatStok",
                            "value": "={{ $json.intent === 'lihatStok' }}",
                            "type": "boolean"
                        },
                        {
                            "id": "route-laporan-penjualan",
                            "name": "laporanPenjualan",
                            "value": "={{ $json.intent === 'laporanPenjualan' }}",
                            "type": "boolean"
                        },
                        {
                            "id": "route-laporan-inventory",
                            "name": "laporanInventory",
                            "value": "={{ $json.intent === 'laporanInventory' }}",
                            "type": "boolean"
                        },
                        {
                            "id": "route-tambah-produk",
                            "name": "tambahProduk",
                            "value": "={{ $json.intent === 'tambahProduk' }}",
                            "type": "boolean"
                        },
                        {
                            "id": "route-tambah-kategori",
                            "name": "tambahKategori",
                            "value": "={{ $json.intent === 'tambahKategori' }}",
                            "type": "boolean"
                        },
                        {
                            "id": "route-tambah-varian",
                            "name": "tambahVarian",
                            "value": "={{ $json.intent === 'tambahVarian' }}",
                            "type": "boolean"
                        },
                        {
                            "id": "route-tambah-komposisi",
                            "name": "tambahKomposisi",
                            "value": "={{ $json.intent === 'tambahKomposisi' }}",
                            "type": "boolean"
                        },
                        {
                            "id": "route-help",
                            "name": "help",
                            "value": "={{ $json.intent === 'help' }}",
                            "type": "boolean"
                        },
                        {
                            "id": "route-chat",
                            "name": "chat",
                            "value": "={{ $json.intent === 'chat' }}",
                            "type": "boolean"
                        }
                    ]
                },
                "options": {}
            },
            "id": "route-intent",
            "name": "Route Intent",
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [1340, 300]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "check-tambah-stok",
                            "leftValue": "={{ $json.tambahStok }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "true"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "switch-tambah-stok",
            "name": "Switch - Tambah Stok",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3,
            "position": [1560, 200]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "check-lihat-stok",
                            "leftValue": "={{ $json.lihatStok }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "true"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "switch-lihat-stok",
            "name": "Switch - Lihat Stok",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3,
            "position": [1560, 300]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "check-laporan-penjualan",
                            "leftValue": "={{ $json.laporanPenjualan }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "true"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "switch-laporan-penjualan",
            "name": "Switch - Laporan Penjualan",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3,
            "position": [1560, 400]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "check-laporan-inventory",
                            "leftValue": "={{ $json.laporanInventory }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "true"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "switch-laporan-inventory",
            "name": "Switch - Laporan Inventory",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3,
            "position": [1560, 500]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "check-tambah-produk",
                            "leftValue": "={{ $json.tambahProduk }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "true"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "switch-tambah-produk",
            "name": "Switch - Tambah Produk",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3,
            "position": [1560, 600]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "check-tambah-kategori",
                            "leftValue": "={{ $json.tambahKategori }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "true"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "switch-tambah-kategori",
            "name": "Switch - Tambah Kategori",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3,
            "position": [1560, 700]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "check-tambah-varian",
                            "leftValue": "={{ $json.tambahVarian }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "true"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "switch-tambah-varian",
            "name": "Switch - Tambah Varian",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3,
            "position": [1560, 800]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "check-tambah-komposisi",
                            "leftValue": "={{ $json.tambahKomposisi }}",
                            "type": "boolean",
                            "operation": "true"
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "switch-tambah-komposisi",
            "name": "Switch - Tambah Komposisi",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3,
            "position": [1560, 900]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "check-help",
                            "leftValue": "={{ $json.help }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "true"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "switch-help",
            "name": "Switch - Help",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3,
            "position": [1560, 1000]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "check-chat",
                            "leftValue": "={{ $json.chat }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "true"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "switch-chat",
            "name": "Switch - Chat AI",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3,
            "position": [1560, 1100]
        },
        {
            "parameters": {
                "jsCode": "// Parse pesan untuk mengekstrak informasi tambah stok\nconst message = $input.item.json.originalMessage || '';\n\n// Pattern untuk mengekstrak: nama bahan dan jumlah\n// Contoh: \"tambah stok beras 10\" atau \"stok +5 untuk beras\"\nconst patterns = [\n  /tambah\\s+stok\\s+(.+?)\\s+(\\d+(?:\\.\\d+)?)/i,\n  /stok\\s+tambah\\s+(.+?)\\s+(\\d+(?:\\.\\d+)?)/i,\n  /stok\\s+\\+\\s*(\\d+(?:\\.\\d+)?)\\s+(.+)/i,\n  /(.+?)\\s+stok\\s+(\\d+(?:\\.\\d+)?)/i,\n  /tambah\\s+(\\d+(?:\\.\\d+)?)\\s+(.+?)\\s+stok/i\n];\n\nlet bahanName = null;\nlet quantity = null;\n\nfor (const pattern of patterns) {\n  const match = message.match(pattern);\n  if (match) {\n    bahanName = match[1]?.trim();\n    quantity = parseFloat(match[2] || match[1]);\n    if (isNaN(quantity)) {\n      quantity = parseFloat(match[1]);\n      bahanName = match[2]?.trim();\n    }\n    if (bahanName && quantity && !isNaN(quantity)) break;\n  }\n}\n\n// Jika tidak ditemukan, coba ekstrak angka dan kata terakhir\nif (!quantity || !bahanName) {\n  const numberMatch = message.match(/\\d+(?:\\.\\d+)?/);\n  if (numberMatch) {\n    quantity = parseFloat(numberMatch[0]);\n  }\n  // Ambil kata-kata setelah \"stok\" atau sebelum angka\n  const words = message.split(/\\s+/);\n  const stokIndex = words.findIndex(w => /stok/i.test(w));\n  if (stokIndex >= 0 && stokIndex < words.length - 1) {\n    bahanName = words.slice(stokIndex + 1).filter(w => !/\\d/.test(w)).join(' ');\n  }\n}\n\nreturn {\n  json: {\n    ...$input.item.json,\n    action: 'tambahStok',\n    bahanName: bahanName,\n    quantity: quantity,\n    needsConfirmation: !bahanName || !quantity || isNaN(quantity)\n  }\n};"
            },
            "id": "parse-tambah-stok",
            "name": "Parse Tambah Stok",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [1780, 200]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/stocks",
                "authentication": "none",
                "options": {}
            },
            "id": "get-products-list",
            "name": "Get Stocks List",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [2000, 200],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Cari bahan berdasarkan nama\nconst stocks = $input.item.json.data || $input.item.json || [];\nconst searchName = $('Parse Tambah Stok').item.json.bahanName;\n\nif (!searchName) {\n  return {\n    json: {\n      ...$('Parse Tambah Stok').item.json,\n      error: 'Nama bahan tidak ditemukan dalam pesan',\n      suggestion: 'Format: tambah stok [nama bahan] [jumlah]'\n    }\n  };\n}\n\n// Fuzzy search untuk nama bahan\nconst searchLower = searchName.toLowerCase();\nconst matchedBahan = stocks.find(s => {\n  const name = (s.name || s.nama_bahan || s.nama || '').toLowerCase();\n  return name.includes(searchLower) || searchLower.includes(name);\n});\n\nif (!matchedBahan) {\n  return {\n    json: {\n      ...$('Parse Tambah Stok').item.json,\n      error: `Bahan \"${searchName}\" tidak ditemukan`,\n      availableBahan: stocks.slice(0, 10).map(s => s.name || s.nama_bahan || s.nama)\n    }\n  };\n}\n\nreturn {\n  json: {\n    ...$('Parse Tambah Stok').item.json,\n    bahanId: matchedBahan.id || matchedBahan.id_bahan,\n    bahanName: matchedBahan.name || matchedBahan.nama_bahan || matchedBahan.nama,\n    currentStock: matchedBahan.quantity || matchedBahan.stok_bahan || 0,\n    foundBahan: matchedBahan\n  }\n};"
            },
            "id": "find-product",
            "name": "Find Bahan",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2220, 200]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/stocks/{{ $json.bahanId }}",
                "authentication": "none",
                "options": {}
            },
            "id": "get-stock-info",
            "name": "Get Stock Info",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [2440, 200],
            "continueOnFail": true
        },
        {
            "parameters": {
                "method": "PUT",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/stocks/{{ $json.bahanId }}",
                "authentication": "none",
                "sendBody": true,
                "contentType": "json",
                "specifyBody": "json",
                "jsonBody": "={\n  \"stok_bahan\": {{ $json.currentStock + $json.quantity }}\n}",
                "options": {}
            },
            "id": "update-stock",
            "name": "Update Stock",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [2660, 200],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Format response untuk tambah stok\nconst data = $input.item.json.data || $input.item.json;\nconst parseData = $('Parse Tambah Stok').item.json;\nconst findData = $('Find Bahan').item.json;\n\nif (findData.error) {\n  return {\n    json: {\n      ...$input.item.json,\n      responseMessage: `âŒ ${findData.error}\\n\\n${findData.suggestion || ''}\\n\\n${findData.availableBahan ? 'Bahan yang tersedia:\\n' + findData.availableBahan.slice(0, 10).join('\\n') : ''}`\n    }\n  };\n}\n\nif (data.error || data.message) {\n  return {\n    json: {\n      ...$input.item.json,\n      responseMessage: `âŒ Gagal update stok: ${data.message || data.error || 'Error tidak diketahui'}`\n    }\n  };\n}\n\nconst newStock = data.quantity || data.stok_bahan || (findData.currentStock + parseData.quantity);\n\nreturn {\n  json: {\n    ...$input.item.json,\n    responseMessage: `âœ… Stok berhasil ditambahkan!\\n\\nðŸ“¦ Bahan: ${findData.bahanName}\\nâž• Ditambah: ${parseData.quantity}\\nðŸ“Š Stok sekarang: ${newStock}`\n  }\n};"
            },
            "id": "format-tambah-stok-response",
            "name": "Format Response Tambah Stok",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2880, 200]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/stocks",
                "authentication": "none",
                "options": {}
            },
            "id": "get-all-stocks",
            "name": "Get All Stocks",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [1780, 300],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Format laporan stok\nconst stocks = $input.item.json.data || $input.item.json || [];\n\nif (stocks.length === 0) {\n  return {\n    json: {\n      ...$input.item.json,\n      responseMessage: 'ðŸ“¦ Tidak ada data stok tersedia'\n    }\n  };\n}\n\n// Format sebagai list\nlet message = 'ðŸ“¦ *Laporan Stok Inventory*\\n\\n';\n\nstocks.slice(0, 20).forEach((stock, index) => {\n  const nama = stock.name || stock.nama_bahan || stock.nama || 'Tidak diketahui';\n  const stok = stock.quantity || stock.stok_bahan || 0;\n  const satuan = stock.unit || stock.satuan || '';\n  const minStok = stock.minStock || stock.min_stok || 0;\n  \n  const status = stok <= minStok ? 'âš ï¸' : 'âœ…';\n  \n  message += `${status} ${index + 1}. ${nama}\\n   Stok: ${stok} ${satuan}\\n\\n`;\n});\n\nif (stocks.length > 20) {\n  message += `\\n... dan ${stocks.length - 20} item lainnya`;\n}\n\nreturn {\n  json: {\n    ...$input.item.json,\n    responseMessage: message\n  }\n};"
            },
            "id": "format-stok-response",
            "name": "Format Response Stok",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2000, 300]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/reports/sales",
                "authentication": "none",
                "options": {
                    "queryParameters": {
                        "parameters": [
                            {
                                "name": "period",
                                "value": "today"
                            }
                        ]
                    }
                }
            },
            "id": "get-sales-report",
            "name": "Get Sales Report",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [1780, 400],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Format laporan penjualan\nconst report = $input.item.json.data || $input.item.json || {};\n\nlet message = 'ðŸ“Š *Laporan Penjualan*\\n\\n';\n\nif (report.total_sales || report.total) {\n  message += `ðŸ’° Total Penjualan: Rp ${(report.total_sales || report.total || 0).toLocaleString('id-ID')}\\n`;\n}\n\nif (report.total_transactions || report.transactions) {\n  message += `ðŸ›’ Total Transaksi: ${report.total_transactions || report.transactions || 0}\\n`;\n}\n\nif (report.period) {\n  message += `ðŸ“… Periode: ${report.period}\\n`;\n}\n\nif (report.top_products && Array.isArray(report.top_products)) {\n  message += '\\nðŸ† *Produk Terlaris:*\\n';\n  report.top_products.slice(0, 5).forEach((product, index) => {\n    message += `${index + 1}. ${product.nama_produk || product.nama}\\n   Terjual: ${product.quantity || 0}\\n`;\n  });\n}\n\nreturn {\n  json: {\n    ...$input.item.json,\n    responseMessage: message\n  }\n};"
            },
            "id": "format-sales-response",
            "name": "Format Response Sales",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2000, 400]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/reports/inventory",
                "authentication": "none",
                "options": {}
            },
            "id": "get-inventory-report",
            "name": "Get Inventory Report",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [1780, 500],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Format laporan inventory\nconst report = $input.item.json.data || $input.item.json || {};\n\nlet message = 'ðŸ“¦ *Laporan Inventory*\\n\\n';\n\nif (report.total_items) {\n  message += `ðŸ“Š Total Item: ${report.total_items}\\n`;\n}\n\nif (report.low_stock_count) {\n  message += `âš ï¸ Stok Rendah: ${report.low_stock_count} item\\n`;\n}\n\nif (report.total_value) {\n  message += `ðŸ’° Total Nilai: Rp ${(report.total_value || 0).toLocaleString('id-ID')}\\n`;\n}\n\nif (report.low_stock_items && Array.isArray(report.low_stock_items)) {\n  message += '\\nâš ï¸ *Stok Rendah:*\\n';\n  report.low_stock_items.slice(0, 10).forEach((item, index) => {\n    message += `${index + 1}. ${item.nama_bahan || item.nama}\\n   Stok: ${item.stok || 0}\\n`;\n  });\n}\n\nreturn {\n  json: {\n    ...$input.item.json,\n    responseMessage: message\n  }\n};"
            },
            "id": "format-inventory-response",
            "name": "Format Response Inventory",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2000, 500]
        },
        {
            "parameters": {
                "jsCode": "// Parse pesan untuk tambah produk\nconst message = $input.item.json.originalMessage || '';\n\n// Ekstrak informasi produk dari pesan\n// Format: \"tambah produk [nama] harga [harga] kategori [kategori]\"\nconst nameMatch = message.match(/produk\\s+(.+?)(?:\\s+harga|\\s+kategori|$)/i);\nconst priceMatch = message.match(/harga\\s+(\\d+)/i);\nconst categoryMatch = message.match(/kategori\\s+(.+?)(?:\\s+harga|$)/i);\n\nreturn {\n  json: {\n    ...$input.item.json,\n    action: 'tambahProduk',\n    productName: nameMatch ? nameMatch[1].trim() : null,\n    price: priceMatch ? parseFloat(priceMatch[1]) : null,\n    categoryName: categoryMatch ? categoryMatch[1].trim() : null,\n    needsInfo: !nameMatch || !priceMatch\n  }\n};"
            },
            "id": "parse-tambah-produk",
            "name": "Parse Tambah Produk",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [1780, 600]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/categories",
                "authentication": "none",
                "options": {}
            },
            "id": "get-categories-for-product",
            "name": "Get Categories",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [2000, 600],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Cari kategori berdasarkan nama\nconst categories = $input.item.json.data || $input.item.json || [];\nconst parseData = $('Parse Tambah Produk').item.json;\n\nlet categoryId = 1; // default\n\nif (parseData.categoryName) {\n  const searchLower = parseData.categoryName.toLowerCase();\n  const matchedCategory = categories.find(c => {\n    const name = (c.name || c.nama_kategori || c.nama || '').toLowerCase();\n    return name.includes(searchLower) || searchLower.includes(name);\n  });\n  \n  if (matchedCategory) {\n    categoryId = matchedCategory.id || matchedCategory.id_kategori || 1;\n  }\n}\n\nreturn {\n  json: {\n    ...parseData,\n    categoryId: categoryId\n  }\n};"
            },
            "id": "find-category-for-product",
            "name": "Find Category for Product",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2220, 600]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/products",
                "authentication": "none",
                "sendBody": true,
                "contentType": "json",
                "specifyBody": "json",
                "jsonBody": "={\n  \"nama_produk\": \"{{ $json.productName }}\",\n  \"harga\": {{ $json.price }},\n  \"id_kategori\": {{ $json.categoryId || 1 }}\n}",
                "options": {}
            },
            "id": "create-product",
            "name": "Create Product",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [2440, 600],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Format response untuk tambah produk\nconst data = $input.item.json;\nconst productName = $('Parse Tambah Produk').item.json.productName;\n\nif (data.error || data.message) {\n  return {\n    json: {\n      ...$input.item.json,\n      responseMessage: `âŒ Gagal menambah produk: ${data.message || data.error || 'Error tidak diketahui'}`\n    }\n  };\n}\n\nreturn {\n  json: {\n    ...$input.item.json,\n    responseMessage: `âœ… Produk berhasil ditambahkan!\\n\\nðŸ“¦ Nama: ${productName}\\nðŸ’° Harga: Rp ${(data.harga || $('Parse Tambah Produk').item.json.price || 0).toLocaleString('id-ID')}\\nðŸ†” ID: ${data.id_produk || data.id || 'N/A'}`\n  }\n};"
            },
            "id": "format-tambah-produk-response",
            "name": "Format Response Tambah Produk",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2660, 600]
        },
        {
            "parameters": {
                "jsCode": "// Parse pesan untuk tambah kategori\nconst message = $input.item.json.originalMessage || '';\n\n// Ekstrak nama kategori\nconst categoryMatch = message.match(/(?:tambah|add|create)\\s+kategori\\s+(.+)/i);\n\nreturn {\n  json: {\n    ...$input.item.json,\n    action: 'tambahKategori',\n    categoryName: categoryMatch ? categoryMatch[1].trim() : null,\n    needsInfo: !categoryMatch\n  }\n};"
            },
            "id": "parse-tambah-kategori",
            "name": "Parse Tambah Kategori",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [1780, 700]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/categories",
                "authentication": "none",
                "sendBody": true,
                "contentType": "json",
                "specifyBody": "json",
                "jsonBody": "={\n  \"nama_kategori\": \"{{ $json.categoryName }}\"\n}",
                "options": {}
            },
            "id": "create-category",
            "name": "Create Category",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [2000, 700],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Format response untuk tambah kategori\nconst data = $input.item.json;\nconst categoryName = $('Parse Tambah Kategori').item.json.categoryName;\n\nif (data.error || data.message) {\n  return {\n    json: {\n      ...$input.item.json,\n      responseMessage: `âŒ Gagal menambah kategori: ${data.message || data.error || 'Error tidak diketahui'}`\n    }\n  };\n}\n\nreturn {\n  json: {\n    ...$input.item.json,\n    responseMessage: `âœ… Kategori berhasil ditambahkan!\\n\\nðŸ“ Nama: ${categoryName}\\nðŸ†” ID: ${data.id_kategori || data.id || 'N/A'}`\n  }\n};"
            },
            "id": "format-tambah-kategori-response",
            "name": "Format Response Tambah Kategori",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2220, 700]
        },
        {
            "parameters": {
                "jsCode": "// Parse pesan untuk tambah varian\nconst message = $input.item.json.originalMessage || '';\n\n// Ekstrak informasi varian\nconst variantMatch = message.match(/(?:tambah|add)\\s+varian\\s+(.+?)(?:\\s+produk|\\s+untuk|$)/i);\nconst productMatch = message.match(/(?:produk|untuk)\\s+(.+)/i);\n\nreturn {\n  json: {\n    ...$input.item.json,\n    action: 'tambahVarian',\n    variantName: variantMatch ? variantMatch[1].trim() : null,\n    productName: productMatch ? productMatch[1].trim() : null,\n    needsInfo: !variantMatch || !productMatch\n  }\n};"
            },
            "id": "parse-tambah-varian",
            "name": "Parse Tambah Varian",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [1780, 800]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/products",
                "authentication": "none",
                "options": {}
            },
            "id": "get-products-for-variant",
            "name": "Get Products for Variant",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [2000, 800],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Cari produk berdasarkan nama untuk varian\nconst products = $input.item.json.data || $input.item.json || [];\nconst searchName = $('Parse Tambah Varian').item.json.productName;\n\nif (!searchName) {\n  return {\n    json: {\n      ...$('Parse Tambah Varian').item.json,\n      error: 'Nama produk tidak ditemukan dalam pesan',\n      suggestion: 'Format: tambah varian [nama varian] untuk [nama produk]'\n    }\n  };\n}\n\n// Fuzzy search untuk nama produk\nconst searchLower = searchName.toLowerCase();\nconst matchedProduct = products.find(p => {\n  const name = (p.name || p.nama_produk || p.nama || '').toLowerCase();\n  return name.includes(searchLower) || searchLower.includes(name);\n});\n\nif (!matchedProduct) {\n  return {\n    json: {\n      ...$('Parse Tambah Varian').item.json,\n      error: `Produk \"${searchName}\" tidak ditemukan`,\n      availableProducts: products.slice(0, 10).map(p => p.name || p.nama_produk || p.nama)\n    }\n  };\n}\n\nreturn {\n  json: {\n    ...$('Parse Tambah Varian').item.json,\n    productId: matchedProduct.id || matchedProduct.id_produk,\n    foundProduct: matchedProduct\n  }\n};"
            },
            "id": "find-product-for-variant",
            "name": "Find Product for Variant",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2220, 800]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/variants",
                "authentication": "none",
                "sendBody": true,
                "contentType": "json",
                "specifyBody": "json",
                "jsonBody": "={\n  \"nama_varian\": \"{{ $json.variantName }}\",\n  \"id_produk\": {{ $json.productId || 1 }}\n}",
                "options": {}
            },
            "id": "create-variant",
            "name": "Create Variant",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [2440, 800],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Format response untuk tambah varian\nconst data = $input.item.json.data || $input.item.json;\nconst parseData = $('Parse Tambah Varian').item.json;\nconst findData = $('Find Product for Variant').item.json;\n\nif (findData.error) {\n  return {\n    json: {\n      ...$input.item.json,\n      responseMessage: `âŒ ${findData.error}\\n\\n${findData.suggestion || ''}\\n\\n${findData.availableProducts ? 'Produk yang tersedia:\\n' + findData.availableProducts.slice(0, 10).join('\\n') : ''}`\n    }\n  };\n}\n\nif (data.error || data.message) {\n  return {\n    json: {\n      ...$input.item.json,\n      responseMessage: `âŒ Gagal menambah varian: ${data.message || data.error || 'Error tidak diketahui'}`\n    }\n  };\n}\n\nreturn {\n  json: {\n    ...$input.item.json,\n    responseMessage: `âœ… Varian berhasil ditambahkan!\\n\\nðŸ·ï¸ Nama: ${parseData.variantName}\\nðŸ“¦ Produk: ${findData.productName || parseData.productName}\\nðŸ†” ID: ${data.id_varian || data.id || 'N/A'}`\n  }\n};"
            },
            "id": "format-tambah-varian-response",
            "name": "Format Response Tambah Varian",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2660, 800]
        },
        {
            "parameters": {
                "jsCode": "// Parse pesan untuk tambah komposisi\nconst message = $input.item.json.originalMessage || '';\n\n// Ekstrak informasi komposisi\n// Format: \"tambah komposisi produk [nama] bahan [bahan] jumlah [jumlah]\"\nconst productMatch = message.match(/produk\\s+(.+?)(?:\\s+bahan|$)/i);\nconst ingredientMatch = message.match(/bahan\\s+(.+?)(?:\\s+jumlah|$)/i);\nconst quantityMatch = message.match(/jumlah\\s+(\\d+(?:\\.\\d+)?)/i);\n\nreturn {\n  json: {\n    ...$input.item.json,\n    action: 'tambahKomposisi',\n    productName: productMatch ? productMatch[1].trim() : null,\n    ingredientName: ingredientMatch ? ingredientMatch[1].trim() : null,\n    quantity: quantityMatch ? parseFloat(quantityMatch[1]) : null,\n    needsInfo: !productMatch || !ingredientMatch || !quantityMatch\n  }\n};"
            },
            "id": "parse-tambah-komposisi",
            "name": "Parse Tambah Komposisi",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [1780, 900]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/products",
                "authentication": "none",
                "options": {}
            },
            "id": "get-products-for-composition",
            "name": "Get Products for Composition",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [2000, 900],
            "continueOnFail": true
        },
        {
            "parameters": {
                "method": "GET",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/stocks",
                "authentication": "none",
                "options": {}
            },
            "id": "get-stocks-for-composition",
            "name": "Get Stocks for Composition",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [2220, 900],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Cari produk dan bahan untuk komposisi\nconst products = $('Get Products for Composition').item.json.data || $('Get Products for Composition').item.json || [];\nconst stocks = $input.item.json.data || $input.item.json || [];\nconst parseData = $('Parse Tambah Komposisi').item.json;\n\n// Cari produk\nconst productSearch = (parseData.productName || '').toLowerCase();\nconst matchedProduct = products.find(p => {\n  const name = (p.name || p.nama_produk || p.nama || '').toLowerCase();\n  return name.includes(productSearch) || productSearch.includes(name);\n});\n\n// Cari bahan\nconst ingredientSearch = (parseData.ingredientName || '').toLowerCase();\nconst matchedBahan = stocks.find(s => {\n  const name = (s.name || s.nama_bahan || s.nama || '').toLowerCase();\n  return name.includes(ingredientSearch) || ingredientSearch.includes(name);\n});\n\nif (!parseData.productName) {\n  return {\n    json: {\n      ...parseData,\n      error: 'Nama produk tidak ditemukan dalam pesan',\n      suggestion: 'Format: tambah komposisi produk [nama] bahan [bahan] jumlah [jumlah]'\n    }\n  };\n}\n\nif (!matchedProduct) {\n  return {\n    json: {\n      ...parseData,\n      error: `Produk \"${parseData.productName}\" tidak ditemukan`,\n      availableProducts: products.slice(0, 10).map(p => p.name || p.nama_produk || p.nama)\n    }\n  };\n}\n\nif (!parseData.ingredientName) {\n  return {\n    json: {\n      ...parseData,\n      error: 'Nama bahan tidak ditemukan dalam pesan',\n      suggestion: 'Format: tambah komposisi produk [nama] bahan [bahan] jumlah [jumlah]'\n    }\n  };\n}\n\nif (!matchedBahan) {\n  return {\n    json: {\n      ...parseData,\n      error: `Bahan \"${parseData.ingredientName}\" tidak ditemukan`,\n      availableBahan: stocks.slice(0, 10).map(s => s.name || s.nama_bahan || s.nama)\n    }\n  };\n}\n\nreturn {\n  json: {\n    ...parseData,\n    productId: matchedProduct.id || matchedProduct.id_produk,\n    ingredientId: matchedBahan.id || matchedBahan.id_bahan,\n    productName: matchedProduct.name || matchedProduct.nama_produk || matchedProduct.nama,\n    ingredientName: matchedBahan.name || matchedBahan.nama_bahan || matchedBahan.nama\n  }\n};"
            },
            "id": "find-product-and-bahan",
            "name": "Find Product and Bahan",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2440, 900]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/compositions",
                "authentication": "none",
                "sendBody": true,
                "contentType": "json",
                "specifyBody": "json",
                "jsonBody": "={\n  \"id_produk\": {{ $json.productId || 1 }},\n  \"id_bahan\": {{ $json.ingredientId || 1 }},\n  \"jumlah_per_porsi\": {{ $json.quantity || 1 }}\n}",
                "options": {}
            },
            "id": "create-composition",
            "name": "Create Composition",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [2660, 900],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Format response untuk tambah komposisi\nconst data = $input.item.json.data || $input.item.json;\nconst findData = $('Find Product and Bahan').item.json;\n\nif (findData.error) {\n  return {\n    json: {\n      ...$input.item.json,\n      responseMessage: `âŒ ${findData.error}\\n\\n${findData.suggestion || ''}\\n\\n${findData.availableProducts ? 'Produk yang tersedia:\\n' + findData.availableProducts.slice(0, 10).join('\\n') : ''}\\n${findData.availableBahan ? 'Bahan yang tersedia:\\n' + findData.availableBahan.slice(0, 10).join('\\n') : ''}`\n    }\n  };\n}\n\nif (data.error || data.message) {\n  return {\n    json: {\n      ...$input.item.json,\n      responseMessage: `âŒ Gagal menambah komposisi: ${data.message || data.error || 'Error tidak diketahui'}`\n    }\n  };\n}\n\nreturn {\n  json: {\n    ...$input.item.json,\n    responseMessage: `âœ… Komposisi berhasil ditambahkan!\\n\\nðŸ“¦ Produk: ${findData.productName}\\nðŸ¥˜ Bahan: ${findData.ingredientName}\\nðŸ“Š Jumlah: ${findData.quantity} per porsi`\n  }\n};"
            },
            "id": "format-tambah-komposisi-response",
            "name": "Format Response Tambah Komposisi",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2880, 900]
        },
        {
            "parameters": {
                "jsCode": "// Generate help message\nconst helpMessage = `ðŸ¤– *Menu Bantuan Chatbot UMKM*\\n\\n` +\n  `*Perintah yang Tersedia:*\\n\\n` +\n  `ðŸ“¦ *Stok:*\\n` +\n  `â€¢ Tambah stok: \"tambah stok [nama produk] [jumlah]\"\\n` +\n  `â€¢ Lihat stok: \"lihat stok\" atau \"cek stok\"\\n\\n` +\n  `ðŸ“Š *Laporan:*\\n` +\n  `â€¢ Laporan penjualan: \"laporan penjualan\"\\n` +\n  `â€¢ Laporan inventory: \"laporan inventory\"\\n\\n` +\n  `âž• *Tambah Data:*\\n` +\n  `â€¢ Tambah produk: \"tambah produk [nama] harga [harga] kategori [kategori]\"\\n` +\n  `â€¢ Tambah kategori: \"tambah kategori [nama]\"\\n` +\n  `â€¢ Tambah varian: \"tambah varian [nama] untuk [produk]\"\\n` +\n  `â€¢ Tambah komposisi: \"tambah komposisi produk [nama] bahan [bahan] jumlah [jumlah]\"\\n\\n` +\n  `ðŸ’¬ *Chat & Konsultasi:*\\n` +\n  `â€¢ Tanya apapun tentang penjualan, stok, atau bisnis Anda\\n` +\n  `â€¢ Contoh: \"bagaimana penjualan hari ini?\"\\n\\n` +\n  `Ketik *help* untuk menampilkan menu ini lagi.`;\n\nreturn {\n  json: {\n    ...$input.item.json,\n    responseMessage: helpMessage\n  }\n};"
            },
            "id": "generate-help",
            "name": "Generate Help",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [1780, 1000]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/reports/sales",
                "authentication": "none",
                "options": {}
            },
            "id": "get-sales-data-for-ai",
            "name": "Get Sales Data for AI",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [1780, 1100],
            "continueOnFail": true
        },
        {
            "parameters": {
                "method": "GET",
                "url": "={{ $env.API_BASE_URL || 'http://localhost:8000' }}/api/dashboard/summary",
                "authentication": "none",
                "options": {}
            },
            "id": "get-dashboard-summary",
            "name": "Get Dashboard Summary",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [2000, 1100],
            "continueOnFail": true
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyBzb2hZXhceAjTlW1nfiXdlK710-t5TQ20",
                "authentication": "none",
                "sendBody": true,
                "contentType": "json",
                "specifyBody": "json",
                "jsonBody": "={\n  \"contents\": [\n    {\n      \"parts\": [\n        {\n          \"text\": \"Anda adalah asisten AI untuk UMKM yang membantu pemilik bisnis mengelola inventory dan penjualan melalui WhatsApp.\\n\\nData Penjualan:\\n{{ JSON.stringify($('Get Sales Data for AI').item.json.data || $('Get Sales Data for AI').item.json) }}\\n\\nDashboard Summary:\\n{{ JSON.stringify($('Get Dashboard Summary').item.json.data || $('Get Dashboard Summary').item.json) }}\\n\\nPertanyaan dari user: {{ $('Extract Pesan').item.json.message }}\\n\\nJawablah dengan ramah, jelas, dan dalam bahasa Indonesia. Berikan saran yang praktis dan membantu untuk bisnis UMKM. Jika ada pertanyaan tentang data penjualan atau inventory, gunakan data yang telah disediakan di atas.\"\n        }\n      ]\n    }\n  ]\n}",
                "options": {}
            },
            "id": "call-gemini-ai",
            "name": "Call Gemini AI",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [2220, 1100],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Extract response dari Gemini AI\nconst geminiResponse = $input.item.json;\n\nlet aiMessage = 'Maaf, saya tidak bisa memproses pertanyaan Anda saat ini.';\n\nif (geminiResponse.candidates && geminiResponse.candidates[0]) {\n  const candidate = geminiResponse.candidates[0];\n  if (candidate.content && candidate.content.parts && candidate.content.parts[0]) {\n    aiMessage = candidate.content.parts[0].text || aiMessage;\n  }\n}\n\n// Fallback jika struktur berbeda\nif (aiMessage === 'Maaf, saya tidak bisa memproses pertanyaan Anda saat ini.') {\n  if (geminiResponse.text) {\n    aiMessage = geminiResponse.text;\n  } else if (geminiResponse.message) {\n    aiMessage = geminiResponse.message;\n  } else if (typeof geminiResponse === 'string') {\n    aiMessage = geminiResponse;\n  }\n}\n\n// Ambil data original message\nconst originalData = $('Extract Pesan').item.json;\n\nreturn {\n  json: {\n    ...originalData,\n    responseMessage: `ðŸ¤– ${aiMessage}`,\n    intent: 'chat'\n  }\n};"
            },
            "id": "format-ai-response",
            "name": "Format AI Response",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2440, 1100]
        },
        {
            "parameters": {
                "jsCode": "// Merge semua response dari berbagai branch\nconst items = $input.all();\n\n// Cari item yang memiliki responseMessage\nlet responseItem = null;\nfor (const item of items) {\n  if (item.json.responseMessage) {\n    responseItem = item;\n    break;\n  }\n}\n\n// Jika tidak ada, coba cari dari error atau message\nif (!responseItem) {\n  for (const item of items) {\n    if (item.json.error || item.json.message) {\n      responseItem = {\n        json: {\n          responseMessage: `âŒ ${item.json.error || item.json.message || 'Terjadi kesalahan'}`\n        }\n      };\n      break;\n    }\n  }\n}\n\n// Jika masih tidak ada, gunakan item pertama\nif (!responseItem) {\n  responseItem = items[0] || { json: {} };\n}\n\n// Ambil chatId dari original message\nconst originalData = $('Extract Pesan').item.json;\n\n// Default message jika tidak ada\nlet message = responseItem.json.responseMessage || 'Terima kasih!';\n\n// Jika masih tidak ada responseMessage, buat pesan default berdasarkan intent\nif (!responseItem.json.responseMessage && originalData) {\n  message = 'Pesan Anda telah diterima. Silakan coba lagi atau ketik *help* untuk melihat menu bantuan.';\n}\n\nreturn {\n  json: {\n    chatId: originalData.chatId,\n    message: message,\n    originalIntent: responseItem.json.intent || 'unknown'\n  }\n};"
            },
            "id": "merge-responses",
            "name": "Merge Responses",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2660, 600]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=http://localhost:3000/api/sendText",
                "authentication": "none",
                "sendBody": true,
                "contentType": "json",
                "specifyBody": "json",
                "jsonBody": "={\n  \"session\": \"default\",\n  \"chatId\": \"{{ $json.chatId }}\",\n  \"text\": \"{{ $json.message }}\"\n}",
                "options": {
                    "response": {
                        "response": {
                            "responseFormat": "json",
                            "fullResponse": false
                        }
                    }
                }
            },
            "id": "send-whatsapp-response",
            "name": "Send WhatsApp Response",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [2880, 600],
            "continueOnFail": true
        }
    ],
    "connections": {
        "Webhook - Terima Pesan WA": {
            "main": [
                [
                    {
                        "node": "Respond to Webhook",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Extract Pesan",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Extract Pesan": {
            "main": [
                [
                    {
                        "node": "Cek Pesan Kosong?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Cek Pesan Kosong?": {
            "main": [
                [
                    {
                        "node": "AI Agent - Classify Intent",
                        "type": "main",
                        "index": 0
                    }
                ],
                []
            ]
        },
        "AI Agent - Classify Intent": {
            "main": [
                [
                    {
                        "node": "Deteksi Intent",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Deteksi Intent": {
            "main": [
                [
                    {
                        "node": "Route Intent",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Route Intent": {
            "main": [
                [
                    {
                        "node": "Switch - Tambah Stok",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Switch - Lihat Stok",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Switch - Laporan Penjualan",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Switch - Laporan Inventory",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Switch - Tambah Produk",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Switch - Tambah Kategori",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Switch - Tambah Varian",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Switch - Tambah Komposisi",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Switch - Help",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Switch - Chat AI",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch - Tambah Stok": {
            "main": [
                [
                    {
                        "node": "Parse Tambah Stok",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Tambah Stok": {
            "main": [
                [
                    {
                        "node": "Get Stocks List",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Stocks List": {
            "main": [
                [
                    {
                        "node": "Find Bahan",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Find Bahan": {
            "main": [
                [
                    {
                        "node": "Get Stock Info",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Stock Info": {
            "main": [
                [
                    {
                        "node": "Update Stock",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Update Stock": {
            "main": [
                [
                    {
                        "node": "Format Response Tambah Stok",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Response Tambah Stok": {
            "main": [
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch - Lihat Stok": {
            "main": [
                [
                    {
                        "node": "Get All Stocks",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get All Stocks": {
            "main": [
                [
                    {
                        "node": "Format Response Stok",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Response Stok": {
            "main": [
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch - Laporan Penjualan": {
            "main": [
                [
                    {
                        "node": "Get Sales Report",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Sales Report": {
            "main": [
                [
                    {
                        "node": "Format Response Sales",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Response Sales": {
            "main": [
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch - Laporan Inventory": {
            "main": [
                [
                    {
                        "node": "Get Inventory Report",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Inventory Report": {
            "main": [
                [
                    {
                        "node": "Format Response Inventory",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Response Inventory": {
            "main": [
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch - Tambah Produk": {
            "main": [
                [
                    {
                        "node": "Parse Tambah Produk",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Tambah Produk": {
            "main": [
                [
                    {
                        "node": "Get Categories",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Categories": {
            "main": [
                [
                    {
                        "node": "Find Category for Product",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Find Category for Product": {
            "main": [
                [
                    {
                        "node": "Create Product",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Create Product": {
            "main": [
                [
                    {
                        "node": "Format Response Tambah Produk",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Response Tambah Produk": {
            "main": [
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch - Tambah Kategori": {
            "main": [
                [
                    {
                        "node": "Parse Tambah Kategori",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Tambah Kategori": {
            "main": [
                [
                    {
                        "node": "Create Category",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Create Category": {
            "main": [
                [
                    {
                        "node": "Format Response Tambah Kategori",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Response Tambah Kategori": {
            "main": [
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch - Tambah Varian": {
            "main": [
                [
                    {
                        "node": "Parse Tambah Varian",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Tambah Varian": {
            "main": [
                [
                    {
                        "node": "Get Products for Variant",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Products for Variant": {
            "main": [
                [
                    {
                        "node": "Find Product for Variant",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Find Product for Variant": {
            "main": [
                [
                    {
                        "node": "Create Variant",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Create Variant": {
            "main": [
                [
                    {
                        "node": "Format Response Tambah Varian",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Response Tambah Varian": {
            "main": [
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch - Tambah Komposisi": {
            "main": [
                [
                    {
                        "node": "Parse Tambah Komposisi",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Tambah Komposisi": {
            "main": [
                [
                    {
                        "node": "Get Products for Composition",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Products for Composition": {
            "main": [
                [
                    {
                        "node": "Get Stocks for Composition",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Stocks for Composition": {
            "main": [
                [
                    {
                        "node": "Find Product and Bahan",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Find Product and Bahan": {
            "main": [
                [
                    {
                        "node": "Create Composition",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Create Composition": {
            "main": [
                [
                    {
                        "node": "Format Response Tambah Komposisi",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Response Tambah Komposisi": {
            "main": [
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch - Help": {
            "main": [
                [
                    {
                        "node": "Generate Help",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Generate Help": {
            "main": [
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch - Chat AI": {
            "main": [
                [
                    {
                        "node": "Get Sales Data for AI",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Sales Data for AI": {
            "main": [
                [
                    {
                        "node": "Get Dashboard Summary",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Dashboard Summary": {
            "main": [
                [
                    {
                        "node": "Call Gemini AI",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Call Gemini AI": {
            "main": [
                [
                    {
                        "node": "Format AI Response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format AI Response": {
            "main": [
                [
                    {
                        "node": "Merge Responses",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge Responses": {
            "main": [
                [
                    {
                        "node": "Send WhatsApp Response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Send WhatsApp Response": {
            "main": [[]]
        }
    },
    "pinData": {},
    "settings": {
        "executionOrder": "v1"
    },
    "staticData": null,
    "tags": [],
    "triggerCount": 1,
    "updatedAt": "2024-01-01T00:00:00.000Z",
    "versionId": "1"
}
