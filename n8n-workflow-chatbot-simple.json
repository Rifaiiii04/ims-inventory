{
    "name": "WhatsApp Inventory Agent - Fixed",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "whatsapp-inventory-agent",
                "responseMode": "responseNode",
                "options": {}
            },
            "id": "11c1a7be-f458-4698-b906-4f94891c649f",
            "name": "Webhook - Terima Pesan WA",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1.1,
            "position": [-4256, 128],
            "webhookId": "whatsapp-inventory-agent-webhook"
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ { \"success\": true, \"message\": \"Pesan diterima\" } }}",
                "options": {}
            },
            "id": "38d7f722-f173-4a0e-8c58-2041e1c830c2",
            "name": "Respond to Webhook",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [-4256, 320]
        },
        {
            "parameters": {
                "mode": "runOnceForEachItem",
                "jsCode": "// Extract data dari webhook WAHA\nconst body = $input.item.json.body || $input.item.json;\nconst payload = body.payload || body;\n\n// Ambil isi pesan\nlet message = '';\nif (payload.body) message = payload.body;\nelse if (payload.message?.text) message = payload.message.text;\nelse if (payload.text) message = payload.text;\n\n// Cek dari siapa\nconst fromMe = payload.fromMe || false;\n\n// Skip pesan yang dikirim bot sendiri (echo / API)\nif (fromMe === true || fromMe === 'true' || fromMe === 1) {\n  console.log('[SKIP] Message from bot itself');\n  return null;\n}\n\n// Untuk pesan MASUK: balas ke pengirim\nlet chatId = '';\nif (payload.from) chatId = payload.from;\nelse if (payload.chatId) chatId = payload.chatId;\n\n// Normalisasi chatId\nif (chatId) {\n  // kalau ada plus di depan hilangkan\n  chatId = chatId.replace(/^\\+/, '');\n  // pastikan pakai @c.us\n  if (!chatId.includes('@')) chatId = chatId + '@c.us';\n}\n\nconst messageId = payload.id || payload.messageId || '';\nconst timestamp = payload.timestamp || Date.now();\n\nif (!message || message.trim() === '') {\n  console.log('[SKIP] Empty message');\n  return null;\n}\n\nconsole.log('[EXTRACT] Message:', message);\nconsole.log('[EXTRACT] ChatId:', chatId);\n\nreturn {\n  json: {\n    originalMessage: message.trim(),\n    message: message.trim().toLowerCase(),\n    chatId,\n    messageId,\n    timestamp\n  }\n};\n"
            },
            "id": "68e9deba-dcb8-4188-902f-1b0f42e548da",
            "name": "Extract Pesan",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [-4032, 128]
        },
        {
            "parameters": {
                "mode": "runOnceForEachItem",
                "jsCode": "// Cegah duplikat pesan - PERBAIKAN UNTUK MENCEGAH DUPLIKASI\nconst inputData = $input.item.json;\nif (!inputData) return null;\n\nconst workflowStaticData = $getWorkflowStaticData('global');\nif (!workflowStaticData.processedMessages) {\n  workflowStaticData.processedMessages = {};\n}\n\nconst messageId = inputData.messageId || '';\nconst chatId = inputData.chatId || '';\nconst timestamp = inputData.timestamp || Date.now();\nconst messageText = (inputData.message || inputData.originalMessage || '').trim();\n\n// Buat unique key yang lebih robust\nconst uniqueKey = messageId && chatId ? `${chatId}_${messageId}` : `${chatId}_${timestamp}_${messageText.substring(0, 20)}`;\nconst now = Date.now();\n\n// Cek duplikasi dengan waktu yang lebih lama (60 detik)\nif (workflowStaticData.processedMessages[uniqueKey]) {\n  const processedTime = workflowStaticData.processedMessages[uniqueKey];\n  if (now - processedTime < 60000) { // 60 detik\n    console.log(`[DUPLICATE] Skipping: ${uniqueKey} (processed ${Math.floor((now - processedTime) / 1000)}s ago)`);\n    return null;\n  }\n  // Jika lebih dari 60 detik, hapus entry lama\n  delete workflowStaticData.processedMessages[uniqueKey];\n}\n\n// Simpan dengan timestamp\nworkflowStaticData.processedMessages[uniqueKey] = now;\n\n// Cleanup old entries (lebih agresif - 5 menit)\nconst fiveMinutesAgo = now - 300000;\nfor (const key in workflowStaticData.processedMessages) {\n  if (workflowStaticData.processedMessages[key] < fiveMinutesAgo) {\n    delete workflowStaticData.processedMessages[key];\n  }\n}\n\nconsole.log(`[PROCESS] Processing message: ${uniqueKey}`);\n\nreturn { json: { ...inputData, uniqueKey } };"
            },
            "id": "0e40d4b0-4a04-4732-8e01-862490bcfa40",
            "name": "Cegah Duplikat",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [-3808, 128]
        },
        {
            "parameters": {
                "mode": "runOnceForEachItem",
                "jsCode": "// Load config untuk database yang sebenarnya\nconst config = {\n  \"agent_name\": \"WhatsAppInventoryAgent\",\n  \"llm\": {\n    \"provider\": \"ollama\",\n    \"model\": \"gemma3:1b\",\n    \"role_instruction\": \"Kamu adalah asisten inventory angkringan yang ahli dalam database. Analisis pertanyaan user dan buat query SQL yang tepat.\",\n    \"temperature\": 0.3\n  },\n  \"database\": {\n    \"type\": \"mysql\",\n    \"host\": \"localhost\",\n    \"port\": 3306,\n    \"database\": \"angkringan_ims\",\n    \"username\": \"root\",\n    \"password\": \"\"\n  },\n  \"urls\": {\n    \"ollama\": \"http://localhost:11434\",\n    \"waha\": \"http://host.docker.internal:3000\"\n  }\n};\n\nconst inputData = $input.item.json || {};\nconst userMessage = inputData.message || '';\nconst originalMessage = inputData.originalMessage || userMessage;\n\n// Schema database yang SEBENARNYA berdasarkan struktur database Anda\nconst schemaInfo = `STRUKTUR DATABASE ANGKERINGAN IMS (REAL):\n\n1. tbl_bahan - Tabel bahan baku:\n   â€¢ id_bahan (PK), nama_bahan, id_kategori, harga_beli, stok_bahan, is_divisible, satuan, min_stok\n\n2. tbl_produk - Tabel produk menu:\n   â€¢ id_produk (PK), nama_produk, id_kategori, deskripsi, harga, status ('aktif'/'nonaktif')\n\n3. tbl_kategori - Tabel kategori:\n   â€¢ id_kategori (PK), nama_kategori, deskripsi\n\n4. tbl_varian - Tabel varian produk:\n   â€¢ id_varian (PK), id_produk, nama_varian, stok_varian, unit, conversion_rate\n\n5. tbl_transaksi - Tabel transaksi penjualan:\n   â€¢ id_transaksi (PK), tanggal_waktu, total_transaksi, metode_bayar, nama_pelanggan, catatan\n\n6. tbl_transaksi_detail - Detail transaksi:\n   â€¢ id_detail (PK), id_transaksi, id_produk, id_varian, jumlah, harga_satuan, total_harga\n\n7. tbl_komposisi - Komposisi bahan untuk produk:\n   â€¢ id_komposisi (PK), id_produk, id_varian, id_bahan, jumlah_per_porsi, satuan, is_bahan_baku_utama\n\n8. tbl_notifikasi - Notifikasi stok:\n   â€¢ id_notifikasi (PK), id_bahan, batas_minimum, jadwal, aktif\n\n9. tbl_stock_history - Riwayat stok:\n   â€¢ id_history (PK), id_bahan, action, old_data, new_data, description, changed_by\n\n10. tbl_user - Tabel user:\n    â€¢ id_user (PK), nama_user, username, email, level, status\n\n11. tbl_bagian_tubuh - Tabel bagian tubuh (untuk ayam/daging):\n    â€¢ id_bagian (PK), id_produk, nama_bagian, jumlah_per_ekor, harga_per_potong\n\n12. tbl_konversi_produk - Konversi bahan ke produk:\n    â€¢ id_konversi (PK), id_produk_hasil, id_bahan_baku, jumlah_bahan_digunakan, jumlah_produk_dihasilkan`;\n\n// Build prompt untuk analisis query\nconst analysisPrompt = `${config.llm.role_instruction}\n\n${schemaInfo}\n\nPERTANYAAN USER: \"${originalMessage}\"\n\nTUGAS ANDA:\n1. Analisis maksud user (cek stok, laporan penjualan, daftar menu, dll)\n2. Buat query SQL yang VALID untuk database di atas\n3. Query harus mengembalikan data yang relevan\n4. Gunakan LIMIT jika hasil banyak\n5. Prioritaskan data terbaru untuk transaksi\n\nFORMAT JAWABAN HANYA JSON:\n{\n  \"sql_query\": \"SELECT ... FROM ... WHERE ... ORDER BY ... LIMIT ...\",\n  \"intent\": \"stok_bahan|penjualan|menu|kategori|lainnya\",\n  \"reason\": \"Penjelasan singkat mengapa query ini dibuat\"\n}\n\nCONTOH:\n- Untuk \"stok ayam\": {\"sql_query\": \"SELECT nama_bahan, stok_bahan, satuan, min_stok FROM tbl_bahan WHERE nama_bahan LIKE '%ayam%'\", \"intent\": \"stok_bahan\", \"reason\": \"User menanyakan stok bahan ayam\"}\n- Untuk \"laporan hari ini\": {\"sql_query\": \"SELECT DATE(tanggal_waktu) as tanggal, COUNT(*) as jumlah_transaksi, SUM(total_transaksi) as total_penjualan FROM tbl_transaksi WHERE DATE(tanggal_waktu) = CURDATE()\", \"intent\": \"penjualan\", \"reason\": \"User meminta laporan penjualan hari ini\"}\n- Untuk \"daftar menu\": {\"sql_query\": \"SELECT nama_produk, harga, (SELECT nama_kategori FROM tbl_kategori WHERE id_kategori = tbl_produk.id_kategori) as kategori FROM tbl_produk WHERE status = 'aktif' ORDER BY nama_produk\", \"intent\": \"menu\", \"reason\": \"User meminta daftar menu aktif\"}`;\n\nreturn {\n  json: {\n    ...inputData,\n    config: config,\n    analysisPrompt: analysisPrompt,\n    originalMessage: originalMessage\n  }\n};"
            },
            "id": "fd743379-fe26-4635-927a-8e7b6f405e23",
            "name": "Load Config & Build Prompt",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [-3584, 128]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=http://localhost:11434/api/generate",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"model\": \"{{ $json.config.llm.model }}\",\n  \"prompt\": \"{{ $json.analysisPrompt }}\",\n  \"stream\": false,\n  \"options\": {\n    \"temperature\": {{ $json.config.llm.temperature }},\n    \"num_predict\": 500\n  }\n}",
                "options": {
                    "timeout": 30000
                }
            },
            "id": "c706ba4c-1fcd-4dcf-9c17-16612b8de83b",
            "name": "Analyze Query (Ollama)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [-3376, 128],
            "continueOnFail": true
        },
        {
            "parameters": {
                "mode": "runOnceForEachItem",
                "jsCode": "// Parse hasil analisis dari Ollama\nconst ollamaResponse = $input.item.json || {};\nconst originalData = $('Load Config & Build Prompt').item.json || {};\n\nlet aiResponse = '';\nif (ollamaResponse.response) aiResponse = ollamaResponse.response.trim();\nelse if (ollamaResponse.text) aiResponse = ollamaResponse.text.trim();\n\n// Clean response\naiResponse = aiResponse.replace(/```json/gi, '');\naiResponse = aiResponse.replace(/```/g, '');\naiResponse = aiResponse.trim();\n\n// Parse JSON\nlet parsedAnalysis = null;\ntry {\n  parsedAnalysis = JSON.parse(aiResponse);\n} catch (e) {\n  console.log('[PARSE] Failed to parse JSON, trying to extract...');\n  const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    try {\n      parsedAnalysis = JSON.parse(jsonMatch[0]);\n    } catch (e2) {\n      console.error('[PARSE] Failed to parse extracted JSON:', e2.message);\n    }\n  }\n}\n\n// Jika parsing gagal, gunakan enhanced keyword detection DENGAN QUERY YANG LEBIH BAIK\nif (!parsedAnalysis || !parsedAnalysis.sql_query) {\n  const message = originalData.message || '';\n  console.log('[PARSE] Using enhanced keyword detection');\n  \n  parsedAnalysis = {\n    sql_query: \"\",\n    intent: \"unknown\",\n    reason: \"Enhanced keyword detection\"\n  };\n  \n  // === INTENT DETECTION YANG LEBIH KOMPREHENSIF ===\n  \n  // 1. STOK BAHAN (semua bahan atau spesifik)\n  if (message.match(/(stok|sisa|persediaan|inventory|stock)/i)) {\n    // Cek apakah minta semua stok atau spesifik\n    const isAllStok = message.match(/(semua|all|total)/i);\n    \n    // Cari nama bahan spesifik\n    const bahanKeywords = ['ayam', 'mie', 'nasi', 'minyak', 'gula', 'garam', 'bawang', 'telur', 'daging', 'sayur', 'tepung', 'kecap', 'saus', 'merica', 'ikan', 'lele', 'beras', 'teh', 'kopi'];\n    const foundBahan = bahanKeywords.find(keyword => message.includes(keyword));\n    \n    if (isAllStok || message.includes('semua') || message.includes('total')) {\n      // Query semua stok bahan\n      parsedAnalysis.sql_query = `SELECT b.nama_bahan, b.stok_bahan, b.satuan, b.min_stok, b.harga_beli, k.nama_kategori FROM tbl_bahan b LEFT JOIN tbl_kategori k ON b.id_kategori = k.id_kategori ORDER BY b.stok_bahan ASC LIMIT 50`;\n      parsedAnalysis.intent = \"stok_bahan\";\n    } else if (foundBahan) {\n      // Query stok bahan spesifik\n      parsedAnalysis.sql_query = `SELECT b.nama_bahan, b.stok_bahan, b.satuan, b.min_stok, b.harga_beli, k.nama_kategori FROM tbl_bahan b LEFT JOIN tbl_kategori k ON b.id_kategori = k.id_kategori WHERE b.nama_bahan LIKE '%${foundBahan}%' ORDER BY b.stok_bahan ASC LIMIT 15`;\n      parsedAnalysis.intent = \"stok_bahan\";\n    } else if (message.match(/(hampir habis|menipis|minimum|minimal|kritis)/i)) {\n      // Query stok yang menipis (di bawah minimum)\n      parsedAnalysis.sql_query = `SELECT b.nama_bahan, b.stok_bahan, b.satuan, b.min_stok, b.harga_beli, k.nama_kategori FROM tbl_bahan b LEFT JOIN tbl_kategori k ON b.id_kategori = k.id_kategori WHERE b.stok_bahan <= b.min_stok ORDER BY b.stok_bahan ASC LIMIT 20`;\n      parsedAnalysis.intent = \"stok_bahan\";\n    } else {\n      // Default: semua stok\n      parsedAnalysis.sql_query = `SELECT b.nama_bahan, b.stok_bahan, b.satuan, b.min_stok, b.harga_beli, k.nama_kategori FROM tbl_bahan b LEFT JOIN tbl_kategori k ON b.id_kategori = k.id_kategori ORDER BY b.nama_bahan ASC LIMIT 30`;\n      parsedAnalysis.intent = \"stok_bahan\";\n    }\n  } \n  \n  // 2. LAPORAN PENJUALAN (detail dengan period)\n  else if (message.match(/(laporan|penjualan|transaksi|omset|omzet|pendapatan|uang masuk|pemasukan)/i)) {\n    // Deteksi periode waktu\n    let dateCondition = \"DATE(t.tanggal_waktu) = CURDATE()\";\n    let limitClause = \"LIMIT 20\";\n    \n    if (message.includes('kemarin')) {\n      dateCondition = \"DATE(t.tanggal_waktu) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)\";\n    } else if (message.includes('minggu')) {\n      dateCondition = \"DATE(t.tanggal_waktu) >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)\";\n    } else if (message.includes('bulan')) {\n      dateCondition = \"DATE(t.tanggal_waktu) >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)\";\n    } else if (message.includes('hari ini')) {\n      dateCondition = \"DATE(t.tanggal_waktu) = CURDATE()\";\n    } else if (message.includes('minggu ini')) {\n      dateCondition = \"YEARWEEK(t.tanggal_waktu) = YEARWEEK(CURDATE())\";\n    } else if (message.includes('bulan ini')) {\n      dateCondition = \"MONTH(t.tanggal_waktu) = MONTH(CURDATE()) AND YEAR(t.tanggal_waktu) = YEAR(CURDATE())\";\n    }\n    \n    // Query yang lebih detail untuk laporan penjualan\n    parsedAnalysis.sql_query = `\n      SELECT \n        DATE(t.tanggal_waktu) as tanggal,\n        COUNT(DISTINCT t.id_transaksi) as jumlah_transaksi,\n        SUM(t.total_transaksi) as total_penjualan,\n        AVG(t.total_transaksi) as rata_rata_transaksi,\n        t.metode_bayar,\n        COUNT(DISTINCT td.id_produk) as jumlah_produk_terjual,\n        SUM(td.jumlah) as total_item_terjual\n      FROM tbl_transaksi t\n      LEFT JOIN tbl_transaksi_detail td ON t.id_transaksi = td.id_transaksi\n      WHERE ${dateCondition}\n      GROUP BY DATE(t.tanggal_waktu), t.metode_bayar\n      ORDER BY tanggal DESC\n      ${limitClause}`;\n    parsedAnalysis.intent = \"laporan_penjualan\";\n  }\n  \n  // 3. HARGA PRODUK (spesifik produk)\n  else if (message.match(/(harga|price)/i)) {\n    // Extract nama produk dari query\n    const produkKeywords = ['ayam', 'nasi', 'goreng', 'mie', 'bakar', 'ikan', 'lele', 'teh', 'kopi', 'es', 'sate', 'gado', 'gado-gado'];\n    const foundProduk = produkKeywords.find(keyword => message.includes(keyword));\n    \n    if (foundProduk) {\n      parsedAnalysis.sql_query = `SELECT p.nama_produk, p.harga, p.deskripsi, k.nama_kategori, p.status FROM tbl_produk p LEFT JOIN tbl_kategori k ON p.id_kategori = k.id_kategori WHERE p.status = 'aktif' AND p.nama_produk LIKE '%${foundProduk}%' ORDER BY p.nama_produk LIMIT 10`;\n      parsedAnalysis.intent = \"harga_produk\";\n    } else {\n      // Jika tidak spesifik, tampilkan semua menu\n      parsedAnalysis.sql_query = `SELECT p.nama_produk, p.harga, p.deskripsi, k.nama_kategori, p.status FROM tbl_produk p LEFT JOIN tbl_kategori k ON p.id_kategori = k.id_kategori WHERE p.status = 'aktif' ORDER BY p.nama_produk LIMIT 20`;\n      parsedAnalysis.intent = \"menu\";\n    }\n  }\n  \n  // 4. KOMPOSISI / RESEP (spesifik produk)\n  else if (message.match(/(komposisi|resep|bahan untuk|komponen|bahan baku)/i)) {\n    // Extract nama produk dari query\n    const produkKeywords = ['ayam', 'nasi', 'goreng', 'mie', 'bakar', 'ikan', 'lele', 'teh', 'kopi', 'es', 'sate', 'gado', 'gado-gado'];\n    const foundProduk = produkKeywords.find(keyword => message.includes(keyword));\n    \n    if (foundProduk) {\n      // Query komposisi untuk produk spesifik\n      parsedAnalysis.sql_query = `SELECT k.jumlah_per_porsi, k.satuan, b.nama_bahan, p.nama_produk, k.is_bahan_baku_utama FROM tbl_komposisi k LEFT JOIN tbl_bahan b ON k.id_bahan = b.id_bahan LEFT JOIN tbl_produk p ON k.id_produk = p.id_produk WHERE p.status = 'aktif' AND p.nama_produk LIKE '%${foundProduk}%' ORDER BY k.is_bahan_baku_utama DESC, b.nama_bahan LIMIT 20`;\n      parsedAnalysis.intent = \"komposisi\";\n    } else {\n      // Jika tidak spesifik, tampilkan semua komposisi\n      parsedAnalysis.sql_query = `SELECT k.jumlah_per_porsi, k.satuan, b.nama_bahan, p.nama_produk, k.is_bahan_baku_utama FROM tbl_komposisi k LEFT JOIN tbl_bahan b ON k.id_bahan = b.id_bahan LEFT JOIN tbl_produk p ON k.id_produk = p.id_produk WHERE p.status = 'aktif' ORDER BY p.nama_produk, k.is_bahan_baku_utama DESC LIMIT 20`;\n      parsedAnalysis.intent = \"komposisi\";\n    }\n  }\n  \n  // 5. LAPORAN INVENTORY (stok menipis)\n  else if (message.match(/(inventory|laporan stok|stok menipis|bahan menipis)/i)) {\n    parsedAnalysis.sql_query = `SELECT b.nama_bahan, b.stok_bahan, b.satuan, b.min_stok, b.harga_beli, k.nama_kategori FROM tbl_bahan b LEFT JOIN tbl_kategori k ON b.id_kategori = k.id_kategori WHERE b.stok_bahan <= b.min_stok ORDER BY (b.stok_bahan / NULLIF(b.min_stok, 0)) ASC LIMIT 30`;\n    parsedAnalysis.intent = \"laporan_inventory\";\n  }\n  \n  // 6. DETAIL TRANSAKSI / LAPORAN TRANSAKSI\n  else if (message.match(/(detail transaksi|rincian penjualan|item terjual)/i)) {\n    parsedAnalysis.sql_query = `SELECT t.tanggal_waktu, td.jumlah, td.harga_satuan, td.total_harga, p.nama_produk, v.nama_varian, t.nama_pelanggan FROM tbl_transaksi_detail td LEFT JOIN tbl_transaksi t ON td.id_transaksi = t.id_transaksi LEFT JOIN tbl_produk p ON td.id_produk = p.id_produk LEFT JOIN tbl_varian v ON td.id_varian = v.id_varian ORDER BY t.tanggal_waktu DESC LIMIT 15`;\n    parsedAnalysis.intent = \"transaksi_detail\";\n  }\n  \n  // 7. MENU / PRODUK (daftar semua)\n  else if (message.match(/(menu|produk|daftar|list|makanan|minuman)/i)) {\n    parsedAnalysis.sql_query = `SELECT p.nama_produk, p.harga, p.deskripsi, k.nama_kategori, p.status FROM tbl_produk p LEFT JOIN tbl_kategori k ON p.id_kategori = k.id_kategori WHERE p.status = 'aktif' ORDER BY p.nama_produk LIMIT 30`;\n    parsedAnalysis.intent = \"menu\";\n  }\n  \n  // FALLBACK - TAMPILKAN MENU BANTUAN (FOKUS LAPORAN)\n  else {\n    parsedAnalysis.sql_query = `SELECT 'Halo! Saya asisten inventory angkringan.\n\nðŸ“‹ *FITUR YANG TERSEDIA:*\n\n1. *Laporan Stok Bahan*\n   Contoh: \"stok ayam\", \"semua stok bahan\", \"bahan yang menipis\"\n\n2. *Laporan Penjualan*\n   Contoh: \"laporan hari ini\", \"penjualan minggu ini\"\n\n3. *Laporan Inventory*\n   Contoh: \"stok menipis\", \"bahan di bawah minimum\"\n\n4. *Laporan Transaksi*\n   Contoh: \"transaksi hari ini\", \"detail transaksi\"\n\n5. *Komposisi Produk*\n   Contoh: \"komposisi ayam bakar\", \"bahan nasi goreng\"\n\n6. *Harga Produk*\n   Contoh: \"harga ikan lele\", \"harga nasi goreng\"\n\nðŸ’¡ *Tips:* Tanyakan dengan spesifik untuk hasil terbaik!' as pesan`;\n    parsedAnalysis.intent = \"fallback\";\n  }\n}\n\nconsole.log('[ANALYSIS] SQL Query:', parsedAnalysis.sql_query);\nconsole.log('[ANALYSIS] Intent:', parsedAnalysis.intent);\n\n// Tentukan apakah ini fallback (untuk routing)\nconst isFallback = parsedAnalysis.intent === \"fallback\" || \n                  parsedAnalysis.sql_query.includes(\"Halo!\") ||\n                  parsedAnalysis.sql_query.includes(\"FITUR YANG TERSEDIA\");\n\nreturn {\n  json: {\n    ...originalData,\n    queryAnalysis: parsedAnalysis,\n    sqlQuery: parsedAnalysis.sql_query,\n    intent: parsedAnalysis.intent,\n    isFallback: isFallback\n  }\n};"
            },
            "id": "93824a57-833a-404f-aa13-e58cc3a21afe",
            "name": "Parse Query Analysis",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [-3152, 128]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "check-fallback",
                            "leftValue": "={{ $json.isFallback }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "true"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "aff7256c-0a4b-4ac1-a4e6-84fe481e2834",
            "name": "Check: Fallback atau Query DB?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [-2928, 128]
        },
        {
            "parameters": {
                "mode": "runOnceForEachItem",
                "jsCode": "// Generate fallback response langsung\nconst inputData = $input.item.json || {};\nconst queryAnalysis = inputData.queryAnalysis || {};\n\nlet responseMessage = '';\n\nif (queryAnalysis.sql_query && queryAnalysis.sql_query.includes('Halo!')) {\n  // Extract pesan dari query fallback\n  const match = queryAnalysis.sql_query.match(/SELECT\\s+'([^']+)'/);\n  if (match && match[1]) {\n    responseMessage = match[1].replace(/\\\\n/g, '\\n');\n  } else {\n    responseMessage = 'Halo! Saya asisten inventory angkringan.\\n\\nSaya bisa bantu dengan:\\nâ€¢ Cek stok bahan\\nâ€¢ Lihat menu produk\\nâ€¢ Laporan penjualan\\nâ€¢ Info kategori\\n\\nContoh: \"stok ayam\", \"menu apa\", \"laporan hari ini\"';\n  }\n} else {\n  responseMessage = 'Maaf, saya belum paham pertanyaannya.\\n\\nCoba tanyakan tentang:\\nâ€¢ Stok bahan\\nâ€¢ Menu produk\\nâ€¢ Laporan penjualan\\nâ€¢ Kategori\\n\\nContoh: \"Stok ayam berapa?\" atau \"Menu apa saja yang ada?\"';\n}\n\nreturn {\n  json: {\n    ...inputData,\n    responseMessage: responseMessage,\n    shouldSkipDB: true,\n    shouldSkipFormatting: true\n  }\n};"
            },
            "id": "1fab79ca-339e-4432-884a-01f492e859a1",
            "name": "Generate Fallback Response",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [-2928, 320]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "={{ $json.sqlQuery }}",
                "options": {}
            },
            "id": "7409310b-4778-448a-ac5a-50524f1af84b",
            "name": "Execute MySQL Query",
            "type": "n8n-nodes-base.mySql",
            "typeVersion": 2.1,
            "position": [-2704, 16],
            "credentials": {
                "mySql": {
                    "id": "zNBUb1CurI9fnLFM",
                    "name": "MySQL account"
                }
            },
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// Gabungkan SEMUA hasil query dari MySQL - RUN ONCE FOR ALL ITEMS\nconst mysqlResults = $input.all();\n\nconsole.log('[MERGE] Number of result items:', mysqlResults.length);\n\n// Jika tidak ada data\nif (!mysqlResults || mysqlResults.length === 0) {\n  return [{\n    json: {\n      responseMessage: `âŒ *Tidak ada data yang ditemukan.*\n\nSilakan coba dengan kata kunci yang berbeda atau tanyakan hal lain.`,\n      shouldUseOllama: false,\n      dataCount: 0,\n      queryResult: []\n    }\n  }];\n}\n\n// Ambil data dari item pertama untuk konteks\nconst firstItem = mysqlResults[0];\nif (!firstItem || !firstItem.json) {\n  return [{\n    json: {\n      responseMessage: `âŒ *Tidak ada data yang ditemukan.*\n\nSilakan coba dengan kata kunci yang berbeda.`,\n      shouldUseOllama: false,\n      dataCount: 0,\n      queryResult: []\n    }\n  }];\n}\n\nconst originalData = firstItem.json || {};\n\n// Kumpulkan semua data dari semua hasil\nlet allDataRows = [];\n\nmysqlResults.forEach((item) => {\n  if (!item || !item.json) return;\n  \n  const json = item.json;\n  \n  // Kumpulkan data hasil query\n  if (Array.isArray(json)) {\n    allDataRows = allDataRows.concat(json);\n  } else if (json && typeof json === 'object') {\n    // Jika hasil dari node MySQL n8n\n    if (json.rows && Array.isArray(json.rows)) {\n      allDataRows = allDataRows.concat(json.rows);\n    } else if (json.queryResult && Array.isArray(json.queryResult)) {\n      allDataRows = allDataRows.concat(json.queryResult);\n    } else if (json[Object.keys(json)[0]] && Array.isArray(json[Object.keys(json)[0]])) {\n      // Jika format { \"data\": [...] }\n      allDataRows = allDataRows.concat(json[Object.keys(json)[0]]);\n    } else {\n      // Jika single object, tambahkan ke array\n      allDataRows.push(json);\n    }\n  }\n});\n\nconsole.log('[MERGE] Total data rows collected:', allDataRows.length);\n\n// Jika tidak ada data yang dikumpulkan\nif (allDataRows.length === 0) {\n  const intent = originalData.intent || 'unknown';\n  const originalMessage = originalData.originalMessage || '';\n  \n  // Pesan khusus untuk laporan penjualan kosong\n  if (intent === 'laporan_penjualan') {\n    let periodMessage = 'hari ini';\n    if (originalMessage.includes('kemarin')) periodMessage = 'kemarin';\n    else if (originalMessage.includes('minggu')) periodMessage = 'minggu ini';\n    else if (originalMessage.includes('bulan')) periodMessage = 'bulan ini';\n    \n    return [{\n      json: {\n        ...originalData,\n        responseMessage: `ðŸ“Š *LAPORAN PENJUALAN ${periodMessage.toUpperCase()}*\n\nâŒ Tidak ada penjualan ${periodMessage}.\n\nðŸ’¡ Coba tanyakan periode lain atau cek laporan transaksi.`,\n        shouldUseOllama: false,\n        dataCount: 0,\n        queryResult: []\n      }\n    }];\n  }\n  \n  // Pesan khusus untuk transaksi detail kosong\n  if (intent === 'transaksi_detail') {\n    let periodMessage = 'hari ini';\n    if (originalMessage.includes('kemarin')) periodMessage = 'kemarin';\n    else if (originalMessage.includes('minggu')) periodMessage = 'minggu ini';\n    else if (originalMessage.includes('bulan')) periodMessage = 'bulan ini';\n    \n    return [{\n      json: {\n        ...originalData,\n        responseMessage: `ðŸ§¾ *LAPORAN TRANSAKSI ${periodMessage.toUpperCase()}*\n\nâŒ Tidak ada transaksi ${periodMessage}.\n\nðŸ’¡ Coba tanyakan periode lain atau cek laporan penjualan.`,\n        shouldUseOllama: false,\n        dataCount: 0,\n        queryResult: []\n      }\n    }];\n  }\n  \n  // Pesan default untuk intent lain\n  return [{\n    json: {\n      ...originalData,\n      responseMessage: `âŒ *Tidak ada data yang ditemukan untuk pertanyaan Anda.*\n\nCoba tanyakan dengan format yang berbeda atau lebih spesifik.`,\n      shouldUseOllama: false,\n      dataCount: 0,\n      queryResult: []\n    }\n  }];\n}\n\n// === SELALU GUNAKAN OLLAMA UNTUK FORMATTING ===\n// Ambil maksimal 15 baris untuk prompt (agar tidak terlalu panjang)\nconst dataForOllama = allDataRows.slice(0, 15);\n\n// Build prompt untuk formatting yang LEBIH BAIK\nconst intent = originalData.intent || 'unknown';\nconst originalMessage = originalData.originalMessage || '';\n\n// Tentukan instruksi berdasarkan intent\nlet specificInstructions = '';\n\nswitch(intent) {\n  case 'stok_bahan':\n    specificInstructions = 'Format khusus untuk stok bahan:\\n- Tampilkan nama bahan, stok, satuan, dan stok minimum\\n- Beri tanda âš ï¸ jika stok â‰¤ stok minimum\\n- Urutkan dari stok terendah\\n- Sertakan total nilai stok (stok Ã— harga beli) jika ada';\n    break;\n  case 'laporan_penjualan':\n    specificInstructions = 'Format khusus untuk laporan penjualan:\\n- Tampilkan dalam bentuk tabel sederhana\\n- Sertakan total penjualan, jumlah transaksi, rata-rata transaksi\\n- Jika ada data per metode bayar, tampilkan juga\\n- Hitung persentase pertumbuhan jika data lebih dari 1 periode';\n    break;\n  case 'menu':\n    specificInstructions = 'Format khusus untuk menu:\\n- Kelompokkan berdasarkan kategori\\n- Tampilkan nama produk, harga, dan status\\n- Gunakan emoji yang sesuai (ðŸ” untuk makanan, ðŸ¥¤ untuk minuman)\\n- Jika ada deskripsi, singkat jika terlalu panjang';\n    break;\n  case 'transaksi_detail':\n    specificInstructions = 'Format khusus untuk detail transaksi:\\n- Urutkan dari transaksi terbaru\\n- Tampilkan tanggal, nama produk, jumlah, harga satuan, total\\n- Sertakan nama pelanggan jika ada\\n- Hitung subtotal dan total';\n    break;\n  default:\n    specificInstructions = 'Format data dengan rapi menggunakan bullet points atau tabel sederhana.';\n}\n\nconst formatPrompt = `Kamu adalah asisten WhatsApp untuk inventory angkringan \"Waroeng Kita\".\n\nUSER BERTANYA: \"${originalMessage}\"\n\nINTENT DETECTED: ${intent}\n\nDATA DARI DATABASE (${allDataRows.length} baris data):\n\n\\`\\`\\`json\n${JSON.stringify(dataForOllama, null, 2)}\n\\`\\`\\`\n\n${specificInstructions}\n\nINSTRUKSI UMUM FORMATTING:\n\n1. Buat JAWABAN SINGKAT untuk WhatsApp (maksimal 20-25 baris)\n\n2. JANGAN keluarkan data mentah JSON/array\n\n3. Format yang RAMAH di WhatsApp:\n\n   - Gunakan bullet points (â€¢) atau numbering\n\n   - Untuk tabel, gunakan baris baru dan alignment sederhana\n\n   - Untuk uang: format Rp 1.000.000 (gunakan titik sebagai pemisah ribuan)\n\n   - Untuk angka desimal: gunakan koma sebagai pemisah desimal\n\n4. Tambahkan emoji yang relevan di awal dan untuk kategori\n\n5. Jika data banyak (>10 baris), buat RINGKASAN/SUMMARY di akhir\n\n6. Bahasa Indonesia yang SANTUN dan RAMAH\n\n7. JANGAN tambahkan catatan teknis seperti \"berdasarkan data di atas\"\n\n8. Jika ada data kosong atau null, abaikan atau tulis \"tidak tersedia\"\n\n9. Batasi setiap baris maksimal 50 karakter\n\n10. Gunakan **teks tebal** untuk judul utama\n\nCONTOH OUTPUT YANG BAIK UNTUK LAPORAN PENJUALAN:\n\nðŸ“Š *LAPORAN PENJUALAN HARI INI*\n\nâ€¢ Total Transaksi: 45 transaksi\n\nâ€¢ Total Penjualan: Rp 2.450.000\n\nâ€¢ Rata-rata/Transaksi: Rp 54.444\n\nðŸ“ˆ *PER METODE BAYAR:*\n\n- Cash: 30 transaksi (Rp 1.650.000)\n\n- QRIS: 15 transaksi (Rp 800.000)\n\nðŸ•’ *TRANSAKSI TERAKHIR:*\n\n1. 18:30 - Nasi Goreng (2x) = Rp 40.000\n\n2. 18:15 - Es Teh (3x) = Rp 15.000\n\nðŸ’¡ *Catatan:* Penjualan meningkat 15% dari kemarin.\n\nJAWABAN SEKARANG (LANGSUNG TEKS SAJA, TANPA KODE, TANPA JSON):`;\n\nreturn [{\n  json: {\n    ...originalData,\n    queryResult: allDataRows,\n    dataCount: allDataRows.length,\n    formatPrompt: formatPrompt,\n    shouldUseOllama: true,\n    sampleData: dataForOllama,\n    intent: intent\n  }\n}];"
            },
            "id": "86e1bfca-2af1-4158-9e2f-2f24a3418a6e",
            "name": "Merge Query Results & Decide Format",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [-2496, 16]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "check-ollama-needed",
                            "leftValue": "={{ $json.shouldUseOllama }}",
                            "rightValue": true,
                            "operator": {
                                "type": "boolean",
                                "operation": "true"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "7e5f3e6e-6749-4b66-a24d-5b373b2209a1",
            "name": "Check: Need Ollama Formatting?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [-2272, 16]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=http://localhost:11434/api/generate",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"model\": \"{{ $('Load Config & Build Prompt').item.json.config.llm.model }}\",\n  \"prompt\": \"{{ $json.formatPrompt }}\",\n  \"stream\": false,\n  \"options\": {\n    \"temperature\": 0.7,\n    \"num_predict\": 800\n  }\n}",
                "options": {
                    "timeout": 30000
                }
            },
            "id": "4ff80093-dddb-4d94-bcdb-2b02d33c6ad2",
            "name": "Format with Ollama",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [-2048, -80],
            "continueOnFail": true
        },
        {
            "parameters": {
                "mode": "runOnceForEachItem",
                "jsCode": "// Extract dan bersihkan response dari Ollama\nconst ollamaResponse = $input.item.json || {};\nconst originalData = $('Merge Query Results & Decide Format').item.json || {};\n\nlet aiMessage = '';\n\n// Extract response\nif (ollamaResponse.response) aiMessage = ollamaResponse.response.trim();\nelse if (ollamaResponse.text) aiMessage = ollamaResponse.text.trim();\n\n// Clean response AGGRESIF - hapus semua markup dan JSON\naiMessage = aiMessage.replace(/```[\\s\\S]*?```/g, '');\naiMessage = aiMessage.replace(/`/g, '');\naiMessage = aiMessage.replace(/\\*\\*\\*/g, '');\naiMessage = aiMessage.replace(/\\[object Object\\]/gi, '');\naiMessage = aiMessage.replace(/JSON:/gi, '');\naiMessage = aiMessage.replace(/Response:/gi, '');\naiMessage = aiMessage.replace(/Output:/gi, '');\naiMessage = aiMessage.replace(/Answer:/gi, '');\naiMessage = aiMessage.replace(/\\{[\\s\\S]*?\\}/g, '');\naiMessage = aiMessage.replace(/\\[[\\s\\S]*?\\]/g, '');\n\n// Hapus pola-pola JSON yang mungkin tersisa\nconst jsonPatterns = [\n  /\"sql_query\":[\\s\\S]*?\"reason\":/,\n  /\"intent\":.*?,/,\n  /\"pesan\":/,\n  /SELECT.*?as pesan/\n];\n\njsonPatterns.forEach(pattern => {\n  aiMessage = aiMessage.replace(pattern, '');\n});\n\naiMessage = aiMessage.trim();\n\n// Jika response masih mengandung JSON atau terlalu pendek (<20 karakter)\nif (!aiMessage || aiMessage.length < 20 || aiMessage.includes('{') || aiMessage.includes('[') || aiMessage.match(/SELECT|FROM|WHERE|INSERT|UPDATE|DELETE/i)) {\n  console.log('[EXTRACT] Using fallback formatting');\n  \n  // Fallback formatting manual yang LEBIH BAIK\n  const data = originalData.queryResult || [];\n  const dataCount = data.length;\n  const intent = originalData.intent || 'unknown';\n  \n  // Format berdasarkan intent\n  if (intent === 'stok_bahan' || intent === 'laporan_inventory') {\n    aiMessage = `ðŸ“¦ *LAPORAN STOK BAHAN* (${dataCount} item)\\n\\n`;\n    \n    data.forEach((item, idx) => {\n      const nama = item.nama_bahan || 'Bahan';\n      const stok = parseFloat(item.stok_bahan || 0);\n      const min = parseFloat(item.min_stok || 0);\n      const satuan = item.satuan || 'unit';\n      const kategori = item.nama_kategori || '';\n      \n      // Format: Bahan: Ikan Lele, Kategori: makanan, Stok: 2 Kg, Minimal Stok: 3 Kg\n      aiMessage += `${idx + 1}. Bahan: ${nama}`;\n      if (kategori) aiMessage += `, Kategori: ${kategori}`;\n      aiMessage += `, Stok: ${stok.toLocaleString('id-ID')} ${satuan}`;\n      if (min > 0) aiMessage += `, Minimal Stok: ${min.toLocaleString('id-ID')} ${satuan}`;\n      \n      // Status\n      const status = stok <= min ? ' âš¡ KRITIS' : (stok <= min * 1.5 ? ' âš ï¸ HAMPIR HABIS' : ' âœ… AMAN');\n      aiMessage += `${status}\\n`;\n    });\n    \n    // Hitung total stok kritis\n    const kritis = data.filter(item => parseFloat(item.stok_bahan || 0) <= parseFloat(item.min_stok || 0)).length;\n    if (kritis > 0) {\n      aiMessage += `âš ï¸ *PERHATIAN:* ${kritis} bahan dalam kondisi KRITIS!\\n`;\n    }\n    \n    aiMessage += '\\nðŸ”„ Update stok diperlukan untuk bahan yang hampir habis.';\n    \n  } else if (intent === 'transaksi_detail') {\n    aiMessage = `ðŸ§¾ *LAPORAN TRANSAKSI*\\n\\n`;\n    \n    // Helper function untuk format tanggal dengan nama hari\n    const formatTanggal = (dateStr) => {\n      if (!dateStr) return '';\n      const date = new Date(dateStr);\n      const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];\n      const dayName = days[date.getDay()];\n      const tanggal = date.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });\n      const waktu = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });\n      return `${dayName}, ${tanggal} ${waktu}`;\n    };\n    \n    // Group by tanggal\n    const tanggalGroups = {};\n    data.forEach(item => {\n      const tanggal = item.tanggal_waktu ? formatTanggal(item.tanggal_waktu) : 'Tanggal tidak diketahui';\n      if (!tanggalGroups[tanggal]) {\n        tanggalGroups[tanggal] = [];\n      }\n      tanggalGroups[tanggal].push(item);\n    });\n    \n    Object.entries(tanggalGroups).forEach(([tanggal, items]) => {\n      aiMessage += `ðŸ“… *${tanggal}*\\n\\n`;\n      items.forEach((item, idx) => {\n        const produk = item.nama_produk || 'Produk';\n        const jumlah = item.jumlah || 0;\n        const total = parseFloat(item.total_harga || 0);\n        const varian = item.nama_varian ? ` (${item.nama_varian})` : '';\n        const pelanggan = item.nama_pelanggan ? ` - ${item.nama_pelanggan}` : '';\n        \n        aiMessage += `${idx + 1}. ${produk}${varian} (${jumlah}x)${pelanggan}\\n`;\n        aiMessage += `   ðŸ’µ Rp ${total.toLocaleString('id-ID')}\\n\\n`;\n      });\n    });\n    \n    // Hitung total\n    const totalAll = data.reduce((sum, item) => sum + (parseFloat(item.total_harga || 0)), 0);\n    aiMessage += `ðŸ“Š *Total: Rp ${totalAll.toLocaleString('id-ID')}*\\n`;\n    \n  } else if (intent === 'laporan_penjualan') {\n    aiMessage = `ðŸ“Š *LAPORAN PENJUALAN*\\n\\n`;\n    \n    // Hitung totals\n    const totalTransaksi = data.reduce((sum, item) => sum + (parseInt(item.jumlah_transaksi) || 0), 0);\n    const totalPenjualan = data.reduce((sum, item) => sum + (parseFloat(item.total_penjualan) || 0), 0);\n    const avgTransaksi = totalTransaksi > 0 ? totalPenjualan / totalTransaksi : 0;\n    \n    aiMessage += `ðŸ“ˆ *SUMMARY:*\\n`;\n    aiMessage += `â€¢ Total Transaksi: ${totalTransaksi}\\n`;\n    aiMessage += `â€¢ Total Penjualan: Rp ${totalPenjualan.toLocaleString('id-ID')}\\n`;\n    aiMessage += `â€¢ Rata-rata/Transaksi: Rp ${avgTransaksi.toLocaleString('id-ID')}\\n\\n`;\n    \n    // Tampilkan per tanggal jika ada\n    if (data[0] && data[0].tanggal) {\n      aiMessage += `ðŸ“… *PER TANGGAL:*\\n`;\n      data.slice(0, 7).forEach((item, idx) => {\n        aiMessage += `${idx + 1}. ${item.tanggal}: ${item.jumlah_transaksi || 0} transaksi (Rp ${parseFloat(item.total_penjualan || 0).toLocaleString('id-ID')})\\n`;\n      });\n      \n      if (data.length > 7) {\n        aiMessage += `... dan ${data.length - 7} hari lainnya\\n`;\n      }\n    }\n    \n    // Tampilkan per metode bayar jika ada\n    const metodeGroups = {};\n    data.forEach(item => {\n      if (item.metode_bayar) {\n        if (!metodeGroups[item.metode_bayar]) {\n          metodeGroups[item.metode_bayar] = { count: 0, total: 0 };\n        }\n        metodeGroups[item.metode_bayar].count += parseInt(item.jumlah_transaksi) || 0;\n        metodeGroups[item.metode_bayar].total += parseFloat(item.total_penjualan) || 0;\n      }\n    });\n    \n    if (Object.keys(metodeGroups).length > 0) {\n      aiMessage += `\\nðŸ’³ *PER METODE BAYAR:*\\n`;\n      Object.entries(metodeGroups).forEach(([metode, stats], idx) => {\n        const persentase = totalPenjualan > 0 ? (stats.total / totalPenjualan * 100).toFixed(1) : 0;\n        aiMessage += `â€¢ ${metode}: ${stats.count} transaksi (Rp ${stats.total.toLocaleString('id-ID')}) [${persentase}%]\\n`;\n      });\n    }\n    \n  } else {\n    // Generic formatting untuk intent lainnya\n    aiMessage = `ðŸ“‹ *DATA DITEMUKAN* (${dataCount} item)\\n\\n`;\n    \n    const sampleCount = Math.min(10, dataCount);\n    data.slice(0, sampleCount).forEach((item, idx) => {\n      aiMessage += `${idx + 1}. `;\n      \n      // Format berdasarkan field yang ada\n      const fields = [];\n      if (item.nama_produk) fields.push(`Produk: ${item.nama_produk}`);\n      if (item.nama_bahan) fields.push(`Bahan: ${item.nama_bahan}`);\n      if (item.nama_kategori) fields.push(`Kategori: ${item.nama_kategori}`);\n      if (item.tanggal) fields.push(`Tanggal: ${item.tanggal}`);\n      if (item.harga) fields.push(`Harga: Rp ${parseFloat(item.harga).toLocaleString('id-ID')}`);\n      if (item.stok_bahan) fields.push(`Stok: ${parseFloat(item.stok_bahan)} ${item.satuan || ''}`);\n      if (item.jumlah_transaksi) fields.push(`Transaksi: ${item.jumlah_transaksi}`);\n      if (item.total_penjualan) fields.push(`Total: Rp ${parseFloat(item.total_penjualan).toLocaleString('id-ID')}`);\n      \n      if (fields.length > 0) {\n        aiMessage += fields.join(', ');\n      } else {\n        // Fallback ke stringify\n        const itemStr = JSON.stringify(item);\n        aiMessage += itemStr.substring(0, 60);\n        if (itemStr.length > 60) aiMessage += '...';\n      }\n      \n      aiMessage += '\\n';\n    });\n    \n    if (dataCount > sampleCount) {\n      aiMessage += `\\n... dan ${dataCount - sampleCount} data lainnya.\\n`;\n    }\n  }\n  \n  aiMessage += '\\nðŸ’¬ *Butuh info lebih detail?* Tanyakan dengan lebih spesifik!';\n}\n\n// Batasi panjang pesan untuk WhatsApp\nconst MAX_LENGTH = 1600; // WhatsApp batas aman\nif (aiMessage.length > MAX_LENGTH) {\n  // Potong di titik yang logis\n  const cutIndex = aiMessage.lastIndexOf('\\n', MAX_LENGTH - 100);\n  if (cutIndex > 500) {\n    aiMessage = aiMessage.substring(0, cutIndex) + '\\n\\nðŸ“‹ *(Pesan dipotong karena terlalu panjang)*\\nðŸ’¬ *Tanyakan dengan periode yang lebih spesifik untuk data lengkap.*';\n  } else {\n    aiMessage = aiMessage.substring(0, MAX_LENGTH - 100) + '\\n\\nðŸ“‹ *(Pesan dipotong)*\\nðŸ’¬ *Data terlalu banyak, coba batasi periode waktu.*';\n  }\n}\n\n// Pastikan tidak ada karakter aneh\naiMessage = aiMessage.replace(/undefined/g, '');\naiMessage = aiMessage.replace(/null/g, 'tidak tersedia');\naiMessage = aiMessage.replace(/\\n\\s*\\n\\s*\\n/g, '\\n\\n'); // Hapus baris kosong berlebihan\n\nconsole.log('[EXTRACT] Final message length:', aiMessage.length);\n\nreturn {\n  json: {\n    ...originalData,\n    responseMessage: aiMessage\n  }\n};"
            },
            "id": "111a4de8-75a0-4a3e-9cd4-62b4a85be73a",
            "name": "Extract Ollama Response",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [-1824, -80]
        },
        {
            "parameters": {
                "mode": "runOnceForEachItem",
                "jsCode": "// Merge semua response menjadi satu (final node sebelum WhatsApp)\nconst inputData = $input.item.json || {};\n\n// Ambil response dari mana pun asalnya\nlet finalMessage = inputData.responseMessage || '';\nlet chatId = inputData.chatId || '6281380630988@c.us';\nconst originalMessage = inputData.originalMessage || '';\n\n// Jika masih kosong, beri default yang INFORMATIF\nif (!finalMessage || finalMessage.trim() === '' || finalMessage.length < 10) {\n  finalMessage = `ðŸ¤– *Asisten Inventory Angkringan*\\n\\nMaaf, terjadi kesalahan dalam memproses permintaan Anda.\\n\\nðŸ’¡ *Tips:*\\nâ€¢ Gunakan kata kunci spesifik\\nâ€¢ Contoh: \"stok ayam\", \"laporan hari ini\", \"menu minuman\"\\nâ€¢ Batasi periode waktu untuk laporan\\n\\nðŸ”„ Silakan coba lagi dengan format yang berbeda.`;\n}\n\n// Pastikan formatting WhatsApp benar\nfinalMessage = finalMessage.replace(/\\\\n/g, '\\n'); // Convert escaped newlines\nfinalMessage = finalMessage.replace(/\\*\\*/g, '*');   // Pastikan format bold benar\nfinalMessage = finalMessage.replace(/_/g, '');      // Hapus underscore (tidak support di WhatsApp)\n\n// Tambahkan header jika belum ada\nif (!finalMessage.startsWith('ðŸ“Š') && !finalMessage.startsWith('ðŸ“¦') && \n    !finalMessage.startsWith('ðŸ½ï¸') && !finalMessage.startsWith('ðŸ¤–') &&\n    !finalMessage.startsWith('ðŸ“‹') && !finalMessage.startsWith('ðŸ’¬')) {\n  \n  const intent = inputData.intent || '';\n  const emojiMap = {\n    'stok_bahan': 'ðŸ“¦',\n    'laporan_penjualan': 'ðŸ“Š', \n    'laporan_inventory': 'ðŸ“¦',\n    'menu': 'ðŸ½ï¸',\n    'harga_produk': 'ðŸ’°',\n    'komposisi': 'ðŸ“',\n    'transaksi_detail': 'ðŸ§¾'\n  };\n  \n  const emoji = emojiMap[intent] || 'ðŸ’¬';\n  finalMessage = `${emoji} ${finalMessage}`;\n}\n\n// Tambahkan footer/penutup yang konsisten\nif (!finalMessage.includes('ðŸ’¬') && !finalMessage.includes('Butuh info') && \n    !finalMessage.includes('Tanyakan') && !finalMessage.includes('Tips:')) {\n  \n  finalMessage += '\\n\\nðŸ’¬ *Pertanyaan lain?* Tanyakan dengan spesifik untuk hasil terbaik!';\n}\n\n// Batasi panjang pesan untuk WhatsApp (batas aman 2000 karakter)\nconst WHATSAPP_MAX = 2000;\nif (finalMessage.length > WHATSAPP_MAX) {\n  finalMessage = finalMessage.substring(0, WHATSAPP_MAX - 50) + \n                '\\n\\nðŸ“‹ *(Pesan terlalu panjang, dipotong)*\\nðŸ’¬ *Mohon batasi periode waktu atau spesifikasi query.*';\n}\n\nconsole.log('[FINAL] Message length:', finalMessage.length);\nconsole.log('[FINAL] First 150 chars:', finalMessage.substring(0, 150));\n\n// Format untuk WAHA\nconst wahaRequest = {\n  session: 'default',\n  chatId: chatId,\n  text: finalMessage\n};\n\nconsole.log('[DEBUG] WAHA Request prepared for chatId:', chatId);\n\nreturn {\n  json: {\n    session: wahaRequest.session,\n    chatId: wahaRequest.chatId,\n    text: wahaRequest.text,\n    responseMessage: finalMessage,\n    wahaRequest: wahaRequest,\n    originalQuery: originalMessage\n  }\n};"
            },
            "id": "d03b9474-1c5e-4d35-8a4b-cb3c1a6e657f",
            "name": "Final Format",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [-1600, 128]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=http://host.docker.internal:3000/api/sendText",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [{}]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={{ $json.wahaRequest }}",
                "options": {
                    "response": {
                        "response": {
                            "responseFormat": "json"
                        }
                    },
                    "timeout": 10000
                }
            },
            "id": "a72122ef-bd10-46b2-8e88-e47e8974e0b4",
            "name": "Send WhatsApp Response",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [-1376, 128],
            "continueOnFail": true
        }
    ],
    "pinData": {},
    "connections": {
        "Webhook - Terima Pesan WA": {
            "main": [
                [
                    {
                        "node": "Extract Pesan",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Respond to Webhook",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Extract Pesan": {
            "main": [
                [
                    {
                        "node": "Cegah Duplikat",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Cegah Duplikat": {
            "main": [
                [
                    {
                        "node": "Load Config & Build Prompt",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Load Config & Build Prompt": {
            "main": [
                [
                    {
                        "node": "Analyze Query (Ollama)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Analyze Query (Ollama)": {
            "main": [
                [
                    {
                        "node": "Parse Query Analysis",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Query Analysis": {
            "main": [
                [
                    {
                        "node": "Check: Fallback atau Query DB?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check: Fallback atau Query DB?": {
            "main": [
                [
                    {
                        "node": "Generate Fallback Response",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Execute MySQL Query",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Generate Fallback Response": {
            "main": [
                [
                    {
                        "node": "Final Format",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Execute MySQL Query": {
            "main": [
                [
                    {
                        "node": "Merge Query Results & Decide Format",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge Query Results & Decide Format": {
            "main": [
                [
                    {
                        "node": "Check: Need Ollama Formatting?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check: Need Ollama Formatting?": {
            "main": [
                [
                    {
                        "node": "Format with Ollama",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Final Format",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format with Ollama": {
            "main": [
                [
                    {
                        "node": "Extract Ollama Response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Extract Ollama Response": {
            "main": [
                [
                    {
                        "node": "Final Format",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Final Format": {
            "main": [
                [
                    {
                        "node": "Send WhatsApp Response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "active": true,
    "settings": {
        "executionOrder": "v1"
    },
    "versionId": "55493be5-d5cc-4c65-ab3b-118081d1c3f0",
    "meta": {
        "templateCredsSetupCompleted": true,
        "instanceId": "5af7d02029ba6243127cacb5bd0d4293718443cfb3d1bcf87d3824e6eeefa2d9"
    },
    "id": "XIUPxBxpkd63gPBq",
    "tags": []
}
